<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Silvia â€” Agenda Calendario</title>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & BASE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --primary: #1e40af;
  --primary-light: #dbeafe;
  --green: #22c55e;
  --orange: #f59e0b;
  --orange-light: #fef3c7;
  --red: #ef4444;
  --bg: #f8fafc;
  --white: #ffffff;
  --border: #e2e8f0;
  --text: #1e293b;
  --text-secondary: #64748b;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
  --radius: 12px;
  --radius-sm: 8px;
}

body {
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  min-height: 100vh;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar {
  width: 240px;
  background: var(--white);
  border-right: 1px solid var(--border);
  padding: 24px 16px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  z-index: 100;
}

.sidebar-logo {
  font-size: 22px;
  font-weight: 800;
  color: var(--primary);
  padding: 0 12px 4px;
}

.sidebar-payoff {
  font-size: 12px;
  color: var(--text-secondary);
  padding: 0 12px 20px;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.sidebar-divider {
  height: 1px;
  background: var(--border);
  margin: 0 12px 16px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  color: var(--text-secondary);
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
}

.sidebar-item:hover { background: var(--bg); color: var(--text); }
.sidebar-item.active { background: var(--primary); color: white; }
.sidebar-item svg { width: 20px; height: 20px; flex-shrink: 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN CONTENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main {
  flex: 1;
  margin-left: 240px;
  padding: 28px 32px;
  min-height: 100vh;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 16px;
}

.page-title {
  font-size: 24px;
  font-weight: 700;
  color: var(--text);
}

.header-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.view-toggle {
  display: flex;
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
}

.view-btn {
  padding: 8px 16px;
  border: none;
  background: transparent;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
}

.view-btn:not(:last-child) { border-right: 1px solid var(--border); }
.view-btn.active { background: var(--primary); color: white; }
.view-btn:hover:not(.active) { background: var(--bg); }

.nav-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.nav-btn {
  width: 36px;
  height: 36px;
  border: 1px solid var(--border);
  background: var(--white);
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--text-secondary);
  transition: all 0.15s;
}

.nav-btn:hover { background: var(--bg); color: var(--text); }
.nav-btn svg { width: 18px; height: 18px; }

.today-btn {
  padding: 8px 16px;
  border: 1px solid var(--border);
  background: var(--white);
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  color: var(--text);
  cursor: pointer;
  transition: all 0.15s;
}

.today-btn:hover { background: var(--bg); }

.current-period {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  min-width: 200px;
  text-align: center;
}

.btn-new-appt {
  padding: 10px 20px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.15s;
}

.btn-new-appt:hover { background: #1e3a8a; }
.btn-new-appt svg { width: 16px; height: 16px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALENDAR â€” MONTH VIEW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.calendar-card {
  background: var(--white);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.cal-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  background: var(--bg);
  border-bottom: 1px solid var(--border);
}

.cal-weekday {
  padding: 12px 8px;
  text-align: center;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  color: var(--text-secondary);
  letter-spacing: 0.5px;
}

.cal-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
}

.cal-day {
  min-height: 110px;
  border-right: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  padding: 6px;
  cursor: pointer;
  transition: background 0.1s;
  position: relative;
}

.cal-day:nth-child(7n) { border-right: none; }
.cal-day:hover { background: #f1f5f9; }

.cal-day.other-month { background: #fafbfc; }
.cal-day.other-month .day-number { color: #cbd5e1; }

.cal-day.today {
  background: var(--primary-light);
}

.cal-day.today .day-number {
  background: var(--primary);
  color: white;
  border-radius: 50%;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.day-number {
  font-size: 13px;
  font-weight: 500;
  color: var(--text);
  margin-bottom: 4px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
}

.day-events {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.day-event {
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: pointer;
  font-weight: 500;
  transition: opacity 0.15s;
}

.day-event:hover { opacity: 0.85; }

.day-event.tipo-nuovo {
  background: var(--primary-light);
  color: var(--primary);
  border-left: 3px solid var(--primary);
}

.day-event.tipo-richiamo {
  background: var(--orange-light);
  color: #92400e;
  border-left: 3px solid var(--orange);
}

.day-more {
  font-size: 11px;
  color: var(--text-secondary);
  padding: 2px 6px;
  cursor: pointer;
  font-weight: 500;
}

.day-more:hover { color: var(--primary); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALENDAR â€” WEEK VIEW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.week-container {
  display: flex;
  background: var(--white);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.week-time-col {
  width: 60px;
  flex-shrink: 0;
  border-right: 1px solid var(--border);
  padding-top: 56px;
}

.week-time-slot {
  height: 60px;
  display: flex;
  align-items: flex-start;
  justify-content: flex-end;
  padding-right: 8px;
  font-size: 11px;
  color: var(--text-secondary);
  position: relative;
  top: -8px;
}

.week-days-container {
  flex: 1;
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  overflow: hidden;
}

.week-day-col {
  border-right: 1px solid var(--border);
  position: relative;
}

.week-day-col:last-child { border-right: none; }

.week-day-header {
  height: 56px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border-bottom: 1px solid var(--border);
  background: var(--bg);
  position: sticky;
  top: 0;
  z-index: 2;
}

.week-day-header.today-header {
  background: var(--primary-light);
}

.week-day-name {
  font-size: 11px;
  text-transform: uppercase;
  color: var(--text-secondary);
  font-weight: 600;
  letter-spacing: 0.5px;
}

.week-day-num {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
}

.week-day-header.today-header .week-day-num {
  color: var(--primary);
}

.week-slots {
  position: relative;
}

.week-hour-line {
  height: 60px;
  border-bottom: 1px solid #f1f5f9;
}

.week-event {
  position: absolute;
  left: 2px;
  right: 2px;
  border-radius: 4px;
  padding: 4px 6px;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  z-index: 1;
  overflow: hidden;
  transition: opacity 0.15s;
}

.week-event:hover { opacity: 0.85; }

.week-event.tipo-nuovo {
  background: var(--primary-light);
  color: var(--primary);
  border-left: 3px solid var(--primary);
}

.week-event.tipo-richiamo {
  background: var(--orange-light);
  color: #92400e;
  border-left: 3px solid var(--orange);
}

.week-event-time { font-size: 10px; opacity: 0.8; }
.week-event-title { font-weight: 600; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALENDAR â€” DAY VIEW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.day-view-container {
  background: var(--white);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.day-view-header {
  padding: 16px 20px;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  font-size: 16px;
  font-weight: 600;
}

.day-view-body {
  display: flex;
}

.day-view-times {
  width: 60px;
  flex-shrink: 0;
  border-right: 1px solid var(--border);
}

.day-view-content {
  flex: 1;
  position: relative;
}

.day-hour-row {
  height: 60px;
  border-bottom: 1px solid #f1f5f9;
}

.day-time-label {
  height: 60px;
  display: flex;
  align-items: flex-start;
  justify-content: flex-end;
  padding-right: 8px;
  font-size: 11px;
  color: var(--text-secondary);
  position: relative;
  top: -8px;
}

.day-event {
  position: absolute;
  left: 4px;
  right: 4px;
  border-radius: 6px;
  padding: 8px 10px;
  cursor: pointer;
  z-index: 1;
  transition: transform 0.1s, box-shadow 0.1s;
}

.day-event:hover {
  transform: scale(1.01);
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
}

.day-event.tipo-nuovo {
  background: var(--primary-light);
  color: var(--primary);
  border-left: 4px solid var(--primary);
}

.day-event.tipo-richiamo {
  background: var(--orange-light);
  color: #92400e;
  border-left: 4px solid var(--orange);
}

.day-event-time { font-size: 11px; font-weight: 500; opacity: 0.7; }
.day-event-name { font-size: 13px; font-weight: 600; margin: 2px 0; }
.day-event-desc { font-size: 11px; opacity: 0.7; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.4);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}

.modal-overlay.active { opacity: 1; pointer-events: all; }

.modal {
  background: var(--white);
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  width: 480px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
  transform: translateY(10px);
  transition: transform 0.2s;
}

.modal-overlay.active .modal { transform: translateY(0); }

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
}

.modal-title {
  font-size: 18px;
  font-weight: 600;
}

.modal-close {
  width: 32px;
  height: 32px;
  border: none;
  background: transparent;
  cursor: pointer;
  color: var(--text-secondary);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
}

.modal-close:hover { background: var(--bg); color: var(--text); }

.modal-body { padding: 24px; }

.modal-footer {
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
}

.form-row.full { grid-template-columns: 1fr; }

.form-group { display: flex; flex-direction: column; gap: 6px; }

.form-label {
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.form-input, .form-select, .form-textarea {
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-family: inherit;
  color: var(--text);
  transition: border-color 0.15s, box-shadow 0.15s;
  background: var(--white);
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

.form-textarea { resize: vertical; min-height: 80px; }

/* Lead search */
.lead-search-wrapper { position: relative; }

.lead-search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-lg);
  max-height: 200px;
  overflow-y: auto;
  z-index: 10;
  display: none;
}

.lead-search-results.show { display: block; }

.lead-search-item {
  padding: 10px 12px;
  cursor: pointer;
  font-size: 13px;
  border-bottom: 1px solid #f1f5f9;
  display: flex;
  align-items: center;
  gap: 8px;
}

.lead-search-item:hover { background: var(--bg); }
.lead-search-item:last-child { border-bottom: none; }

.lead-search-item .lead-icon {
  width: 28px;
  height: 28px;
  background: var(--primary-light);
  color: var(--primary);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
  flex-shrink: 0;
}

/* Buttons */
.btn {
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  border: none;
  transition: all 0.15s;
  font-family: inherit;
}

.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: #1e3a8a; }
.btn-save { background: var(--green); color: white; }
.btn-save:hover { background: #16a34a; }
.btn-danger { background: var(--red); color: white; }
.btn-danger:hover { background: #dc2626; }
.btn-secondary { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
.btn-secondary:hover { background: var(--bg); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL MODAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.detail-row {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid #f1f5f9;
}

.detail-row:last-child { border-bottom: none; }

.detail-icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.detail-icon svg { width: 18px; height: 18px; }
.detail-icon.blue { background: var(--primary-light); color: var(--primary); }
.detail-icon.orange { background: var(--orange-light); color: var(--orange); }
.detail-icon.green { background: #dcfce7; color: var(--green); }

.detail-info { flex: 1; }
.detail-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px; }
.detail-value { font-size: 14px; font-weight: 500; color: var(--text); margin-top: 2px; }

.detail-lead-link {
  color: var(--primary);
  cursor: pointer;
  text-decoration: underline;
  font-weight: 600;
}

.detail-lead-link:hover { color: #1e3a8a; }

.tipo-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.tipo-badge.nuovo { background: var(--primary-light); color: var(--primary); }
.tipo-badge.richiamo { background: var(--orange-light); color: #92400e; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEGEND
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.legend {
  display: flex;
  gap: 20px;
  margin-bottom: 16px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--text-secondary);
}

.legend-dot {
  width: 12px;
  height: 12px;
  border-radius: 3px;
}

.legend-dot.blue { background: var(--primary); }
.legend-dot.orange { background: var(--orange); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOW LINE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.now-line {
  position: absolute;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--red);
  z-index: 3;
  pointer-events: none;
}

.now-line::before {
  content: '';
  position: absolute;
  left: -4px;
  top: -4px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--red);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty-day {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px;
  color: var(--text-secondary);
}

.empty-day svg { width: 48px; height: 48px; opacity: 0.3; margin-bottom: 12px; }
.empty-day p { font-size: 14px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
  .sidebar { display: none; }
  .main { margin-left: 0; padding: 16px; }
  .page-header { flex-direction: column; align-items: flex-start; }
  .form-row { grid-template-columns: 1fr; }
  .week-time-col { width: 40px; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCROLLBAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.week-scroll, .day-scroll {
  max-height: calc(100vh - 200px);
  overflow-y: auto;
}

.week-scroll::-webkit-scrollbar, .day-scroll::-webkit-scrollbar { width: 6px; }
.week-scroll::-webkit-scrollbar-thumb, .day-scroll::-webkit-scrollbar-thumb {
  background: #cbd5e1; border-radius: 3px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTIFICATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  padding: 14px 20px;
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-weight: 500;
  color: white;
  z-index: 2000;
  transform: translateY(20px);
  opacity: 0;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { background: var(--green); }
.toast.error { background: var(--red); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SIDEBAR
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="sidebar">
  <div class="sidebar-logo">SILVIA</div>
  <div class="sidebar-payoff">Vendita</div>
  <div class="sidebar-divider"></div>

  <a class="sidebar-item" href="dashboard.html">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
    Dashboard
  </a>
  <a class="sidebar-item" href="lead.html">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    Lead
  </a>
  <a class="sidebar-item active" href="agenda.html">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Agenda Calendario
  </a>
  <a class="sidebar-item" href="template.html">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
    Template
  </a>
  <a class="sidebar-item" href="impostazioni.html">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    Impostazioni
  </a>
  <a class="sidebar-item" href="report.html">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
    Report
  </a>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main class="main">
  <!-- Header -->
  <div class="page-header">
    <h1 class="page-title">Agenda Calendario</h1>
    <div class="header-controls">
      <div class="legend">
        <div class="legend-item">
          <div class="legend-dot blue"></div>
          Nuovo appuntamento
        </div>
        <div class="legend-item">
          <div class="legend-dot orange"></div>
          Richiamo
        </div>
      </div>

      <div class="nav-group">
        <button class="nav-btn" onclick="navigate(-1)" title="Precedente">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <button class="today-btn" onclick="goToday()">Oggi</button>
        <button class="nav-btn" onclick="navigate(1)" title="Successivo">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
      </div>

      <div class="current-period" id="currentPeriod"></div>

      <div class="view-toggle">
        <button class="view-btn active" data-view="month" onclick="switchView('month')">Mese</button>
        <button class="view-btn" data-view="week" onclick="switchView('week')">Settimana</button>
        <button class="view-btn" data-view="day" onclick="switchView('day')">Giorno</button>
      </div>

      <button class="btn-new-appt" onclick="openCreateModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Nuovo Appuntamento
      </button>
    </div>
  </div>

  <!-- Calendar container -->
  <div id="calendarContainer"></div>
</main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL â€” CREA / MODIFICA APPUNTAMENTO
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modalCreate">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title" id="modalCreateTitle">Nuovo Appuntamento</h3>
      <button class="modal-close" onclick="closeModal('modalCreate')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editApptId">

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Data *</label>
          <input type="date" class="form-input" id="apptData" required>
        </div>
        <div class="form-group">
          <label class="form-label">Ora *</label>
          <input type="time" class="form-input" id="apptOra" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Tipo *</label>
          <select class="form-select" id="apptTipo">
            <option value="nuovo">Nuovo Appuntamento</option>
            <option value="richiamo">Richiamo</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Lead Associato</label>
          <div class="lead-search-wrapper">
            <input type="text" class="form-input" id="apptLeadSearch" placeholder="Cerca per nome o cognome..." autocomplete="off">
            <input type="hidden" id="apptLeadId">
            <input type="hidden" id="apptLeadNome">
            <input type="hidden" id="apptLeadCognome">
            <div class="lead-search-results" id="leadResults"></div>
          </div>
        </div>
      </div>

      <div class="form-row full">
        <div class="form-group">
          <label class="form-label">Descrizione</label>
          <textarea class="form-textarea" id="apptDescrizione" placeholder="Note sull'appuntamento..."></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalCreate')">Annulla</button>
      <button class="btn btn-save" onclick="saveAppointment()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:4px"><polyline points="20 6 9 17 4 12"/></svg>
        Salva
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL â€” DETTAGLIO APPUNTAMENTO
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modalDetail">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Dettaglio Appuntamento</h3>
      <button class="modal-close" onclick="closeModal('modalDetail')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer" id="detailFooter"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FIREBASE + JAVASCRIPT
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script type="module">
// â”€â”€â”€ FIREBASE SETUP â”€â”€â”€
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, getDocs, query, where, orderBy, onSnapshot, Timestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAuYeUI9sNaoXpQCkN_XrXOF34VGWN7oTI",
  authDomain: "silvia-crm-ce19b.firebaseapp.com",
  projectId: "silvia-crm-ce19b",
  storageBucket: "silvia-crm-ce19b.firebasestorage.app",
  messagingSenderId: "1041049614523",
  appId: "1:1041049614523:web:250bd3bc60ffbcfe32119e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// â”€â”€â”€ STATE â”€â”€â”€
let currentView = 'month';
let currentDate = new Date();
let appointments = [];
let leads = [];
let unsubscribe = null;

// â”€â”€â”€ INIT â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  loadLeads();
  subscribeAppointments();
  render();
});

// Expose functions to window for onclick handlers
window.switchView = switchView;
window.navigate = navigate;
window.goToday = goToday;
window.openCreateModal = openCreateModal;
window.closeModal = closeModal;
window.saveAppointment = saveAppointment;
window.openDetail = openDetail;
window.editAppointment = editAppointment;
window.deleteAppointment = deleteAppointment;
window.viewLeadScheda = viewLeadScheda;
window.clickDay = clickDay;
window.clickSlot = clickSlot;
window.showMore = showMore;

// â”€â”€â”€ FIREBASE: LOAD LEADS â”€â”€â”€
async function loadLeads() {
  try {
    const snap = await getDocs(collection(db, 'leads'));
    leads = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  } catch (e) {
    console.error('Errore caricamento leads:', e);
  }
}

// â”€â”€â”€ FIREBASE: SUBSCRIBE APPUNTAMENTI â”€â”€â”€
function subscribeAppointments() {
  if (unsubscribe) unsubscribe();
  unsubscribe = onSnapshot(collection(db, 'appuntamenti'), (snap) => {
    appointments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    render();
  }, (err) => {
    console.error('Errore listener appuntamenti:', err);
  });
}

// â”€â”€â”€ SAVE APPOINTMENT â”€â”€â”€
async function saveAppointment() {
  const data = document.getElementById('apptData').value;
  const ora = document.getElementById('apptOra').value;
  const tipo = document.getElementById('apptTipo').value;
  const leadId = document.getElementById('apptLeadId').value;
  const leadNome = document.getElementById('apptLeadNome').value;
  const leadCognome = document.getElementById('apptLeadCognome').value;
  const descrizione = document.getElementById('apptDescrizione').value;
  const editId = document.getElementById('editApptId').value;

  if (!data || !ora) {
    showToast('Inserisci data e ora', 'error');
    return;
  }

  const apptData = {
    data,
    ora,
    tipo,
    leadId: leadId || '',
    leadNome: leadNome || '',
    leadCognome: leadCognome || '',
    descrizione: descrizione || '',
    completato: false
  };

  try {
    if (editId) {
      await updateDoc(doc(db, 'appuntamenti', editId), apptData);
      showToast('Appuntamento aggiornato!', 'success');
    } else {
      await addDoc(collection(db, 'appuntamenti'), apptData);
      showToast('Appuntamento creato!', 'success');
    }
    closeModal('modalCreate');
  } catch (e) {
    console.error('Errore salvataggio:', e);
    showToast('Errore nel salvataggio', 'error');
  }
}

// â”€â”€â”€ DELETE APPOINTMENT â”€â”€â”€
async function deleteAppointment(id) {
  if (!confirm('Eliminare questo appuntamento?')) return;
  try {
    await deleteDoc(doc(db, 'appuntamenti', id));
    showToast('Appuntamento eliminato', 'success');
    closeModal('modalDetail');
  } catch (e) {
    showToast('Errore eliminazione', 'error');
  }
}

// â”€â”€â”€ NAVIGATION â”€â”€â”€
function navigate(direction) {
  if (currentView === 'month') {
    currentDate.setMonth(currentDate.getMonth() + direction);
  } else if (currentView === 'week') {
    currentDate.setDate(currentDate.getDate() + (7 * direction));
  } else {
    currentDate.setDate(currentDate.getDate() + direction);
  }
  render();
}

function goToday() {
  currentDate = new Date();
  render();
}

function switchView(view) {
  currentView = view;
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`[data-view="${view}"]`).classList.add('active');
  render();
}

// â”€â”€â”€ RENDER â”€â”€â”€
function render() {
  updatePeriodLabel();
  const container = document.getElementById('calendarContainer');
  if (currentView === 'month') renderMonth(container);
  else if (currentView === 'week') renderWeek(container);
  else renderDay(container);
}

function updatePeriodLabel() {
  const el = document.getElementById('currentPeriod');
  const months = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  const days = ['Domenica','LunedÃ¬','MartedÃ¬','MercoledÃ¬','GiovedÃ¬','VenerdÃ¬','Sabato'];

  if (currentView === 'month') {
    el.textContent = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
  } else if (currentView === 'week') {
    const start = getWeekStart(currentDate);
    const end = new Date(start);
    end.setDate(end.getDate() + 6);
    el.textContent = `${start.getDate()} ${months[start.getMonth()].substring(0,3)} â€“ ${end.getDate()} ${months[end.getMonth()].substring(0,3)} ${end.getFullYear()}`;
  } else {
    el.textContent = `${days[currentDate.getDay()]} ${currentDate.getDate()} ${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
  }
}

// â”€â”€â”€ MONTH VIEW â”€â”€â”€
function renderMonth(container) {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);

  // Monday-based (0=Mon...6=Sun)
  let startDow = firstDay.getDay() - 1;
  if (startDow < 0) startDow = 6;

  const today = new Date();
  const todayStr = formatDate(today);

  let html = `<div class="calendar-card">
    <div class="cal-weekdays">
      <div class="cal-weekday">Lun</div><div class="cal-weekday">Mar</div>
      <div class="cal-weekday">Mer</div><div class="cal-weekday">Gio</div>
      <div class="cal-weekday">Ven</div><div class="cal-weekday">Sab</div>
      <div class="cal-weekday">Dom</div>
    </div>
    <div class="cal-grid">`;

  // Previous month days
  const prevLast = new Date(year, month, 0);
  for (let i = startDow - 1; i >= 0; i--) {
    const d = prevLast.getDate() - i;
    const dateStr = formatDate(new Date(year, month - 1, d));
    html += `<div class="cal-day other-month" onclick="clickDay('${dateStr}')">
      <div class="day-number">${d}</div>
      <div class="day-events">${renderDayEvents(dateStr)}</div>
    </div>`;
  }

  // Current month days
  for (let d = 1; d <= lastDay.getDate(); d++) {
    const dateStr = formatDate(new Date(year, month, d));
    const isToday = dateStr === todayStr;
    html += `<div class="cal-day${isToday ? ' today' : ''}" onclick="clickDay('${dateStr}')">
      <div class="day-number">${d}</div>
      <div class="day-events">${renderDayEvents(dateStr)}</div>
    </div>`;
  }

  // Next month days
  const totalCells = startDow + lastDay.getDate();
  const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
  for (let d = 1; d <= remaining; d++) {
    const dateStr = formatDate(new Date(year, month + 1, d));
    html += `<div class="cal-day other-month" onclick="clickDay('${dateStr}')">
      <div class="day-number">${d}</div>
      <div class="day-events">${renderDayEvents(dateStr)}</div>
    </div>`;
  }

  html += '</div></div>';
  container.innerHTML = html;
}

function renderDayEvents(dateStr) {
  const dayAppts = appointments.filter(a => a.data === dateStr);
  if (dayAppts.length === 0) return '';

  let html = '';
  const maxShow = 3;
  dayAppts.sort((a, b) => (a.ora || '').localeCompare(b.ora || ''));

  dayAppts.slice(0, maxShow).forEach(a => {
    const nome = a.leadNome || a.leadCognome ? `${a.leadNome} ${a.leadCognome}`.trim() : 'Senza lead';
    html += `<div class="day-event tipo-${a.tipo}" onclick="event.stopPropagation(); openDetail('${a.id}')" title="${a.ora} - ${nome}">
      ${a.ora ? a.ora.substring(0,5) : ''} ${nome}
    </div>`;
  });

  if (dayAppts.length > maxShow) {
    html += `<div class="day-more" onclick="event.stopPropagation(); showMore('${dateStr}')">+${dayAppts.length - maxShow} altri</div>`;
  }

  return html;
}

function clickDay(dateStr) {
  currentDate = new Date(dateStr + 'T00:00:00');
  switchView('day');
}

function showMore(dateStr) {
  currentDate = new Date(dateStr + 'T00:00:00');
  switchView('day');
}

// â”€â”€â”€ WEEK VIEW â”€â”€â”€
function renderWeek(container) {
  const start = getWeekStart(currentDate);
  const today = new Date();
  const todayStr = formatDate(today);
  const hours = generateHours();

  let html = `<div class="week-container week-scroll">
    <div class="week-time-col">
      ${hours.map(h => `<div class="week-time-slot">${h}</div>`).join('')}
    </div>
    <div class="week-days-container">`;

  const dayNames = ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'];

  for (let i = 0; i < 7; i++) {
    const day = new Date(start);
    day.setDate(day.getDate() + i);
    const dateStr = formatDate(day);
    const isToday = dateStr === todayStr;
    const dayAppts = appointments.filter(a => a.data === dateStr);

    html += `<div class="week-day-col">
      <div class="week-day-header${isToday ? ' today-header' : ''}" onclick="clickDay('${dateStr}')" style="cursor:pointer">
        <div class="week-day-name">${dayNames[i]}</div>
        <div class="week-day-num">${day.getDate()}</div>
      </div>
      <div class="week-slots" onclick="clickSlot(event, '${dateStr}')">
        ${hours.map(() => `<div class="week-hour-line"></div>`).join('')}
        ${isToday ? renderNowLine() : ''}
        ${dayAppts.map(a => renderWeekEvent(a)).join('')}
      </div>
    </div>`;
  }

  html += '</div></div>';
  container.innerHTML = html;
}

function renderWeekEvent(appt) {
  if (!appt.ora) return '';
  const [h, m] = appt.ora.split(':').map(Number);
  const top = ((h - 7) * 60 + m);
  if (top < 0) return '';
  const height = 40;
  const nome = appt.leadNome || appt.leadCognome ? `${appt.leadNome} ${appt.leadCognome}`.trim() : '';
  return `<div class="week-event tipo-${appt.tipo}" style="top:${top}px;height:${height}px" onclick="event.stopPropagation(); openDetail('${appt.id}')">
    <div class="week-event-time">${appt.ora.substring(0,5)}</div>
    <div class="week-event-title">${nome}</div>
  </div>`;
}

function clickSlot(event, dateStr) {
  if (event.target.classList.contains('week-event') || event.target.closest('.week-event')) return;
  const rect = event.currentTarget.getBoundingClientRect();
  const y = event.clientY - rect.top;
  const hour = Math.floor(y / 60) + 7;
  const minutes = Math.floor((y % 60) / 15) * 15;
  openCreateModal(dateStr, `${String(hour).padStart(2,'0')}:${String(minutes).padStart(2,'0')}`);
}

// â”€â”€â”€ DAY VIEW â”€â”€â”€
function renderDay(container) {
  const dateStr = formatDate(currentDate);
  const todayStr = formatDate(new Date());
  const isToday = dateStr === todayStr;
  const hours = generateHours();
  const dayAppts = appointments.filter(a => a.data === dateStr).sort((a,b) => (a.ora||'').localeCompare(b.ora||''));

  const months = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  const days = ['Domenica','LunedÃ¬','MartedÃ¬','MercoledÃ¬','GiovedÃ¬','VenerdÃ¬','Sabato'];

  let html = `<div class="day-view-container day-scroll">
    <div class="day-view-header">
      ${days[currentDate.getDay()]} ${currentDate.getDate()} ${months[currentDate.getMonth()]} ${currentDate.getFullYear()}
      ${dayAppts.length > 0 ? ` â€” <span style="color:var(--primary);font-weight:700">${dayAppts.length} appuntament${dayAppts.length === 1 ? 'o' : 'i'}</span>` : ''}
    </div>
    <div class="day-view-body">
      <div class="day-view-times">
        ${hours.map(h => `<div class="day-time-label">${h}</div>`).join('')}
      </div>
      <div class="day-view-content" onclick="clickSlot(event, '${dateStr}')">
        ${hours.map(() => `<div class="day-hour-row"></div>`).join('')}
        ${isToday ? renderNowLine() : ''}
        ${dayAppts.map(a => renderDayEvent(a)).join('')}
      </div>
    </div>
  </div>`;

  container.innerHTML = html;
}

function renderDayEvent(appt) {
  if (!appt.ora) return '';
  const [h, m] = appt.ora.split(':').map(Number);
  const top = ((h - 7) * 60 + m);
  if (top < 0) return '';
  const height = 50;
  const nome = appt.leadNome || appt.leadCognome ? `${appt.leadNome} ${appt.leadCognome}`.trim() : 'Senza lead';
  return `<div class="day-event tipo-${appt.tipo}" style="top:${top}px;height:${height}px" onclick="event.stopPropagation(); openDetail('${appt.id}')">
    <div class="day-event-time">${appt.ora.substring(0,5)}</div>
    <div class="day-event-name">${nome}</div>
    <div class="day-event-desc">${appt.descrizione ? appt.descrizione.substring(0, 50) : ''}</div>
  </div>`;
}

// â”€â”€â”€ NOW LINE â”€â”€â”€
function renderNowLine() {
  const now = new Date();
  const top = ((now.getHours() - 7) * 60 + now.getMinutes());
  if (top < 0) return '';
  return `<div class="now-line" style="top:${top}px"></div>`;
}

// â”€â”€â”€ MODALS â”€â”€â”€
function openCreateModal(dateStr, ora) {
  document.getElementById('editApptId').value = '';
  document.getElementById('modalCreateTitle').textContent = 'Nuovo Appuntamento';
  document.getElementById('apptData').value = dateStr || formatDate(currentDate);
  document.getElementById('apptOra').value = ora || '09:00';
  document.getElementById('apptTipo').value = 'nuovo';
  document.getElementById('apptLeadSearch').value = '';
  document.getElementById('apptLeadId').value = '';
  document.getElementById('apptLeadNome').value = '';
  document.getElementById('apptLeadCognome').value = '';
  document.getElementById('apptDescrizione').value = '';
  openModal('modalCreate');
}

function openDetail(id) {
  const appt = appointments.find(a => a.id === id);
  if (!appt) return;

  const months = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  const dateObj = new Date(appt.data + 'T00:00:00');
  const dateFormatted = `${dateObj.getDate()} ${months[dateObj.getMonth()]} ${dateObj.getFullYear()}`;
  const nome = appt.leadNome || appt.leadCognome ? `${appt.leadNome} ${appt.leadCognome}`.trim() : 'Nessun lead';

  document.getElementById('detailBody').innerHTML = `
    <div class="detail-row">
      <div class="detail-icon blue">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      </div>
      <div class="detail-info">
        <div class="detail-label">Data e ora</div>
        <div class="detail-value">${dateFormatted} alle ${appt.ora || '--:--'}</div>
      </div>
    </div>
    <div class="detail-row">
      <div class="detail-icon ${appt.tipo === 'richiamo' ? 'orange' : 'blue'}">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      </div>
      <div class="detail-info">
        <div class="detail-label">Tipo</div>
        <div class="detail-value">
          <span class="tipo-badge ${appt.tipo}">
            ${appt.tipo === 'richiamo' ? 'ğŸ””' : 'ğŸ“…'} ${appt.tipo === 'richiamo' ? 'Richiamo' : 'Nuovo Appuntamento'}
          </span>
        </div>
      </div>
    </div>
    <div class="detail-row">
      <div class="detail-icon green">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
      </div>
      <div class="detail-info">
        <div class="detail-label">Lead</div>
        <div class="detail-value">
          ${appt.leadId
            ? `<span class="detail-lead-link" onclick="viewLeadScheda('${appt.leadId}')">${nome}</span>`
            : nome
          }
        </div>
      </div>
    </div>
    ${appt.descrizione ? `
    <div class="detail-row">
      <div class="detail-icon blue">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>
      </div>
      <div class="detail-info">
        <div class="detail-label">Descrizione</div>
        <div class="detail-value">${appt.descrizione}</div>
      </div>
    </div>` : ''}
    ${appt.tipo === 'richiamo' && appt.leadId ? `
    <div style="margin-top:12px;padding:12px;background:var(--orange-light);border-radius:8px;text-align:center">
      <button class="btn btn-primary" onclick="viewLeadScheda('${appt.leadId}')" style="background:var(--orange)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:4px"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
        Vedi Scheda Lead
      </button>
    </div>` : ''}
  `;

  document.getElementById('detailFooter').innerHTML = `
    <button class="btn btn-secondary" onclick="closeModal('modalDetail')">Chiudi</button>
    <button class="btn btn-primary" onclick="editAppointment('${appt.id}')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:4px"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      Modifica
    </button>
    <button class="btn btn-danger" onclick="deleteAppointment('${appt.id}')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:4px"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
      Elimina
    </button>
  `;

  openModal('modalDetail');
}

function editAppointment(id) {
  const appt = appointments.find(a => a.id === id);
  if (!appt) return;

  closeModal('modalDetail');
  setTimeout(() => {
    document.getElementById('editApptId').value = id;
    document.getElementById('modalCreateTitle').textContent = 'Modifica Appuntamento';
    document.getElementById('apptData').value = appt.data;
    document.getElementById('apptOra').value = appt.ora;
    document.getElementById('apptTipo').value = appt.tipo;
    document.getElementById('apptLeadSearch').value = appt.leadNome || appt.leadCognome
      ? `${appt.leadNome} ${appt.leadCognome}`.trim() : '';
    document.getElementById('apptLeadId').value = appt.leadId || '';
    document.getElementById('apptLeadNome').value = appt.leadNome || '';
    document.getElementById('apptLeadCognome').value = appt.leadCognome || '';
    document.getElementById('apptDescrizione').value = appt.descrizione || '';
    openModal('modalCreate');
  }, 250);
}

function viewLeadScheda(leadId) {
  // Navigate to lead page with the leadId
  window.location.href = `lead.html?id=${leadId}`;
}

function openModal(id) {
  document.getElementById(id).classList.add('active');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}

// â”€â”€â”€ LEAD SEARCH â”€â”€â”€
const leadSearchInput = document.getElementById('apptLeadSearch');
const leadResultsDiv = document.getElementById('leadResults');

leadSearchInput.addEventListener('input', (e) => {
  const q = e.target.value.toLowerCase().trim();
  if (q.length < 2) {
    leadResultsDiv.classList.remove('show');
    return;
  }

  const matches = leads.filter(l =>
    (l.nome && l.nome.toLowerCase().includes(q)) ||
    (l.cognome && l.cognome.toLowerCase().includes(q)) ||
    (`${l.nome} ${l.cognome}`.toLowerCase().includes(q))
  ).slice(0, 8);

  if (matches.length === 0) {
    leadResultsDiv.innerHTML = '<div class="lead-search-item" style="color:var(--text-secondary)">Nessun lead trovato</div>';
  } else {
    leadResultsDiv.innerHTML = matches.map(l => `
      <div class="lead-search-item" onclick="selectLead('${l.id}', '${(l.nome||'').replace(/'/g,"\\'")}', '${(l.cognome||'').replace(/'/g,"\\'")}')">
        <div class="lead-icon">${(l.nome||'?')[0].toUpperCase()}${(l.cognome||'?')[0].toUpperCase()}</div>
        ${l.nome || ''} ${l.cognome || ''} ${l.telefono ? `<span style="color:var(--text-secondary);font-size:12px">Â· ${l.telefono}</span>` : ''}
      </div>
    `).join('');
  }
  leadResultsDiv.classList.add('show');
});

window.selectLead = function(id, nome, cognome) {
  document.getElementById('apptLeadId').value = id;
  document.getElementById('apptLeadNome').value = nome;
  document.getElementById('apptLeadCognome').value = cognome;
  document.getElementById('apptLeadSearch').value = `${nome} ${cognome}`.trim();
  leadResultsDiv.classList.remove('show');
};

// Close search results on click outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.lead-search-wrapper')) {
    leadResultsDiv.classList.remove('show');
  }
});

// â”€â”€â”€ HELPERS â”€â”€â”€
function formatDate(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

function getWeekStart(d) {
  const date = new Date(d);
  const day = date.getDay();
  const diff = day === 0 ? -6 : 1 - day; // Monday start
  date.setDate(date.getDate() + diff);
  date.setHours(0, 0, 0, 0);
  return date;
}

function generateHours() {
  const hours = [];
  for (let h = 7; h <= 21; h++) {
    hours.push(`${String(h).padStart(2,'0')}:00`);
  }
  return hours;
}

function showToast(msg, type) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = `toast ${type} show`;
  setTimeout(() => toast.classList.remove('show'), 3000);
}
</script>

</body>
</html>
