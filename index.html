<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Silvia — CRM Vendita</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <!-- SheetJS per import/export Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>

  <!-- ═══ MODIFICA 1/4: CSS Agenda Calendario ═══ -->
  <style>
  /* ── Header Agenda ── */
  .agenda-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:12px; }
  .agenda-controls { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .agenda-legend { display:flex; gap:16px; }
  .agenda-legend-item { display:flex; align-items:center; gap:6px; font-size:13px; color:var(--text-secondary); }
  .agenda-legend-dot { width:10px; height:10px; border-radius:3px; }
  .agenda-legend-dot.blue { background:#3b82f6; }
  .agenda-legend-dot.orange { background:#f59e0b; }
  .agenda-nav { display:flex; align-items:center; gap:6px; }
  .agenda-nav-btn { width:34px; height:34px; border:1px solid var(--border); background:var(--white); border-radius:var(--radius); display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-secondary); transition:all .15s; }
  .agenda-nav-btn:hover { background:var(--bg); color:var(--text); }
  .agenda-nav-btn svg { width:16px; height:16px; }
  .agenda-today-btn { padding:7px 14px; border:1px solid var(--border); background:var(--white); border-radius:var(--radius); font-size:13px; font-weight:500; color:var(--text); cursor:pointer; transition:all .15s; font-family:var(--font); }
  .agenda-today-btn:hover { background:var(--bg); }
  .agenda-period { font-size:17px; font-weight:600; min-width:180px; text-align:center; }
  .agenda-view-toggle { display:flex; background:var(--white); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; }
  .agenda-view-btn { padding:7px 14px; border:none; background:transparent; font-size:13px; font-weight:500; color:var(--text-secondary); cursor:pointer; transition:all .15s; font-family:var(--font); }
  .agenda-view-btn:not(:last-child) { border-right:1px solid var(--border); }
  .agenda-view-btn.active { background:var(--primary); color:white; }
  .agenda-view-btn:hover:not(.active) { background:var(--bg); }

  /* ── Month View ── */
  .cal-card { background:var(--white); border-radius:var(--radius); box-shadow:0 1px 3px rgba(0,0,0,.06); overflow:hidden; }
  .cal-weekdays { display:grid; grid-template-columns:repeat(7,1fr); background:var(--bg); border-bottom:1px solid var(--border); }
  .cal-weekday { padding:10px 8px; text-align:center; font-size:11px; font-weight:600; text-transform:uppercase; color:var(--text-secondary); letter-spacing:.5px; }
  .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); }
  .cal-day { min-height:100px; border-right:1px solid var(--border); border-bottom:1px solid var(--border); padding:5px; cursor:pointer; transition:background .1s; }
  .cal-day:nth-child(7n) { border-right:none; }
  .cal-day:hover { background:#f1f5f9; }
  .cal-day.other-month { background:#fafbfc; }
  .cal-day.other-month .cal-day-num { color:#cbd5e1; }
  .cal-day.today { background:#dbeafe; }
  .cal-day.today .cal-day-num { background:var(--primary); color:white; border-radius:50%; width:26px; height:26px; display:flex; align-items:center; justify-content:center; }
  .cal-day-num { font-size:13px; font-weight:500; margin-bottom:3px; display:inline-flex; align-items:center; justify-content:center; width:26px; height:26px; }
  .cal-day-events { display:flex; flex-direction:column; gap:2px; }
  .cal-evt { font-size:11px; padding:2px 5px; border-radius:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer; font-weight:600; box-shadow:0 1px 2px rgba(0,0,0,.08); transition:transform .1s; }
  .cal-evt:hover { transform:translateY(-1px); }
  .cal-evt.tipo-nuovo { background:#3b82f6; color:white; }
  .cal-evt.tipo-richiamo { background:#f59e0b; color:white; }
  .cal-day-more { font-size:11px; color:var(--text-secondary); padding:1px 5px; cursor:pointer; font-weight:500; }
  .cal-day-more:hover { color:var(--primary); }

  /* ── Week View ── */
  .week-wrap { display:flex; background:var(--white); border-radius:var(--radius); box-shadow:0 1px 3px rgba(0,0,0,.06); overflow:hidden; max-height:calc(100vh - 220px); overflow-y:auto; }
  .week-times { width:56px; flex-shrink:0; border-right:1px solid var(--border); padding-top:52px; }
  .week-time { height:60px; display:flex; align-items:flex-start; justify-content:flex-end; padding-right:8px; font-size:11px; color:var(--text-secondary); position:relative; top:-7px; }
  .week-cols { flex:1; display:grid; grid-template-columns:repeat(7,1fr); }
  .week-col { border-right:1px solid var(--border); position:relative; }
  .week-col:last-child { border-right:none; }
  .week-col-hd { height:52px; display:flex; flex-direction:column; align-items:center; justify-content:center; border-bottom:1px solid var(--border); background:var(--bg); position:sticky; top:0; z-index:2; cursor:pointer; }
  .week-col-hd.today-hd { background:#dbeafe; }
  .week-col-hd-name { font-size:11px; text-transform:uppercase; color:var(--text-secondary); font-weight:600; }
  .week-col-hd-num { font-size:17px; font-weight:700; }
  .week-col-hd.today-hd .week-col-hd-num { color:var(--primary); }
  .week-slots { position:relative; }
  .week-hour-line { height:60px; border-bottom:1px solid #f1f5f9; }
  .week-evt { position:absolute; left:2px; right:2px; border-radius:5px; padding:3px 6px; font-size:11px; cursor:pointer; z-index:1; overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,.12); transition:transform .1s,box-shadow .1s; }
  .week-evt:hover { transform:scale(1.02); box-shadow:0 3px 8px rgba(0,0,0,.18); z-index:5; }
  .week-evt.tipo-nuovo { background:#3b82f6; color:white; }
  .week-evt.tipo-richiamo { background:#f59e0b; color:white; }
  .week-evt-time { font-size:10px; opacity:.9; }
  .week-evt-name { font-weight:700; font-size:11px; line-height:1.2; }
  .week-evt-desc { font-size:10px; opacity:.8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* ── Day View ── */
  .dayv-wrap { background:var(--white); border-radius:var(--radius); box-shadow:0 1px 3px rgba(0,0,0,.06); overflow:hidden; max-height:calc(100vh - 220px); overflow-y:auto; }
  .dayv-header { padding:14px 18px; background:var(--bg); border-bottom:1px solid var(--border); font-size:15px; font-weight:600; }
  .dayv-body { display:flex; }
  .dayv-times { width:56px; flex-shrink:0; border-right:1px solid var(--border); }
  .dayv-content { flex:1; position:relative; }
  .dayv-hour-row { height:60px; border-bottom:1px solid #f1f5f9; }
  .dayv-time-label { height:60px; display:flex; align-items:flex-start; justify-content:flex-end; padding-right:8px; font-size:11px; color:var(--text-secondary); position:relative; top:-7px; }
  .dayv-evt { position:absolute; left:4px; right:4px; border-radius:7px; padding:8px 10px; cursor:pointer; z-index:1; box-shadow:0 1px 4px rgba(0,0,0,.1); transition:transform .1s,box-shadow .1s; }
  .dayv-evt:hover { transform:scale(1.01); box-shadow:0 4px 12px rgba(0,0,0,.15); z-index:5; }
  .dayv-evt.tipo-nuovo { background:#3b82f6; color:white; }
  .dayv-evt.tipo-richiamo { background:#f59e0b; color:white; }
  .dayv-evt-time { font-size:12px; font-weight:500; opacity:.9; }
  .dayv-evt-name { font-size:14px; font-weight:700; margin:2px 0; }
  .dayv-evt-desc { font-size:12px; opacity:.85; }

  /* ── Now Line ── */
  .now-line { position:absolute; left:0; right:0; height:2px; background:#ef4444; z-index:3; pointer-events:none; }
  .now-line::before { content:''; position:absolute; left:-4px; top:-4px; width:10px; height:10px; border-radius:50%; background:#ef4444; }

  /* ── Agenda Modals ── */
  .agenda-modal-overlay { position:fixed; inset:0; background:rgba(15,23,42,.4); backdrop-filter:blur(3px); display:flex; align-items:center; justify-content:center; z-index:1100; opacity:0; pointer-events:none; transition:opacity .2s; }
  .agenda-modal-overlay.open { opacity:1; pointer-events:all; }
  .agenda-modal { background:var(--white); border-radius:var(--radius); box-shadow:0 10px 25px rgba(0,0,0,.1); width:460px; max-width:95vw; max-height:90vh; overflow-y:auto; transform:translateY(8px); transition:transform .2s; }
  .agenda-modal-overlay.open .agenda-modal { transform:translateY(0); }
  .agenda-modal-hd { display:flex; align-items:center; justify-content:space-between; padding:18px 22px; border-bottom:1px solid var(--border); }
  .agenda-modal-hd h3 { font-size:17px; font-weight:600; margin:0; }
  .agenda-modal-close { width:30px; height:30px; border:none; background:transparent; cursor:pointer; color:var(--text-secondary); border-radius:6px; display:flex; align-items:center; justify-content:center; }
  .agenda-modal-close:hover { background:var(--bg); }
  .agenda-modal-body { padding:22px; }
  .agenda-modal-ft { padding:14px 22px; border-top:1px solid var(--border); display:flex; gap:8px; justify-content:flex-end; }
  .ag-form-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:14px; }
  .ag-form-row.full { grid-template-columns:1fr; }
  .ag-form-group { display:flex; flex-direction:column; gap:5px; }
  .ag-form-label { font-size:11px; font-weight:500; color:var(--text-secondary); text-transform:uppercase; letter-spacing:.3px; }
  .ag-lead-search { position:relative; }
  .ag-lead-results { position:absolute; top:100%; left:0; right:0; background:var(--white); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 10px 25px rgba(0,0,0,.1); max-height:180px; overflow-y:auto; z-index:10; display:none; }
  .ag-lead-results.show { display:block; }
  .ag-lead-result-item { padding:8px 10px; cursor:pointer; font-size:13px; border-bottom:1px solid #f1f5f9; display:flex; align-items:center; gap:8px; }
  .ag-lead-result-item:hover { background:var(--bg); }
  .ag-lead-result-item:last-child { border-bottom:none; }
  .ag-lead-result-item .ag-lead-avatar { width:26px; height:26px; background:#dbeafe; color:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:600; flex-shrink:0; }
  .ag-detail-row { display:flex; align-items:flex-start; gap:10px; padding:10px 0; border-bottom:1px solid #f1f5f9; }
  .ag-detail-row:last-child { border-bottom:none; }
  .ag-detail-icon { width:34px; height:34px; border-radius:8px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
  .ag-detail-icon svg { width:16px; height:16px; }
  .ag-detail-icon.blue { background:#dbeafe; color:var(--primary); }
  .ag-detail-icon.orange { background:#fef3c7; color:#f59e0b; }
  .ag-detail-icon.green { background:#dcfce7; color:#22c55e; }
  .ag-detail-label { font-size:11px; color:var(--text-secondary); text-transform:uppercase; }
  .ag-detail-value { font-size:14px; font-weight:500; margin-top:1px; }
  .ag-detail-link { color:var(--primary); cursor:pointer; text-decoration:underline; font-weight:600; }
  .ag-detail-link:hover { color:#1e3a8a; }
  .ag-tipo-badge { display:inline-flex; padding:3px 10px; border-radius:20px; font-size:12px; font-weight:600; }
  .ag-tipo-badge.nuovo { background:#dbeafe; color:var(--primary); }
  .ag-tipo-badge.richiamo { background:#fef3c7; color:#92400e; }
  </style>
</head>
<body>
  <!-- ============ LOGIN ============ -->
  <div id="loginPage" class="login-container">
    <div class="login-card">
      <div class="login-logo">SILVIA</div>
      <div class="login-payoff">Vendita</div>
      <div class="form-group">
        <label for="loginId">ID</label>
        <input type="text" id="loginId" placeholder="Inserisci il tuo ID" autocomplete="off">
      </div>
      <div class="form-group">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" placeholder="Inserisci la password">
      </div>
      <div id="loginError" class="login-error">ID o Password non corretti.</div>
      <button class="btn btn-primary" id="loginBtn">Accedi</button>
    </div>
  </div>

  <!-- ============ APP ============ -->
  <div id="appPage" class="app-container" style="display:none;">
    <!-- Mobile Header -->
    <div class="mobile-header">
      <button class="hamburger" id="hamburgerBtn">
        <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="sidebar-logo">SILVIA</div>
    </div>
    <!-- Overlay mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">SILVIA</div>
        <div class="sidebar-payoff">Vendita</div>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-item active" data-page="dashboard">
          <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          Dashboard
        </button>
        <button class="nav-item" data-page="lead">
          <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Lead
        </button>
        <button class="nav-item" data-page="agenda">
          <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Agenda Calendario
        </button>
        <button class="nav-item" data-page="template">
          <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          Template
        </button>
        <button class="nav-item" data-page="impostazioni">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.32 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Impostazioni
        </button>
        <button class="nav-item" data-page="report">
          <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
          Report
        </button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="mainContent"></main>
  </div>

  <!-- ============ LEAD DETAIL PANEL ============ -->
  <div class="lead-overlay" id="leadOverlay"></div>
  <div class="lead-panel" id="leadPanel">
    <div class="lead-panel-header">
      <h2 id="leadPanelTitle">Nuovo Lead</h2>
      <button class="lead-panel-close" id="leadPanelClose">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="lead-panel-body" id="leadPanelBody"></div>
  </div>

  <!-- ============ MODAL: IMPORT EXCEL ============ -->
  <div class="modal-overlay" id="importModal">
    <div class="modal modal-lg">
      <h2>Importa Lead da Excel</h2>
      <div id="importStep1">
        <div class="dropzone" id="dropzone">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          <p>Trascina il file .xlsx qui o clicca per selezionarlo</p>
          <p class="dropzone-hint">Formato accettato: .xlsx — Usa il template scaricabile</p>
        </div>
        <input type="file" id="importFileInput" accept=".xlsx" style="display:none">
      </div>
      <div id="importStep2" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
          <span style="font-size:14px;font-weight:600;" id="importFileName"></span>
          <span class="lead-error-msg" id="importErrors"></span>
        </div>
        <div style="max-height:350px;overflow:auto;">
          <table class="preview-table" id="previewTable">
            <thead><tr><th>#</th><th>Nome</th><th>Cognome</th><th>Telefono</th><th>Email</th><th>Fonte</th><th>Note</th><th>Stato</th></tr></thead>
            <tbody id="previewBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="importCancelBtn">Annulla</button>
        <button class="btn btn-primary" id="importConfirmBtn" style="display:none;width:auto;">Importa Lead</button>
      </div>
    </div>
  </div>

  <!-- ============ MODAL: CONFERMA ELIMINAZIONE ============ -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal">
      <h2>Conferma eliminazione</h2>
      <p style="font-size:14px;color:var(--text-secondary);margin-bottom:6px;" id="deleteMessage">Sei sicuro? Questa azione è irreversibile.</p>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="deleteCancelBtn">Annulla</button>
        <button class="btn btn-red" id="deleteConfirmBtn">Elimina</button>
      </div>
    </div>
  </div>

  <!-- ============ TOAST ============ -->
  <div class="toast" id="toast"></div>

  <script type="module">
    import {
      db, collection, doc, setDoc, getDocs, addDoc, updateDoc, deleteDoc,
      query, where, orderBy, limit, onSnapshot, serverTimestamp, Timestamp
    } from './js/firebase-config.js';

    // ============================================
    // PAGE VERSION — previene race condition
    // ============================================
    let pageVersion = 0;
    let currentPage = null;

    // ============================================
    // AUTENTICAZIONE
    // ============================================
    const CREDENTIALS = { id: "Silvia", password: "iosonosilvia@2026" };

    let leadUnsubscribe = null;
    let currentLeadId = null;

    const loginPage = document.getElementById('loginPage');
    const appPage = document.getElementById('appPage');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    const loginIdEl = document.getElementById('loginId');
    const loginPasswordEl = document.getElementById('loginPassword');

    if (sessionStorage.getItem('silvia_logged') === 'true') {
      loginPage.style.display = 'none';
      appPage.style.display = 'flex';
      showPage('dashboard');
    }

    loginBtn.addEventListener('click', doLogin);
    loginPasswordEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') doLogin(); });
    loginIdEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') doLogin(); });

    function doLogin() {
      const id = loginIdEl.value.trim();
      const pw = loginPasswordEl.value;
      if (id === CREDENTIALS.id && pw === CREDENTIALS.password) {
        sessionStorage.setItem('silvia_logged', 'true');
        loginPage.style.display = 'none';
        appPage.style.display = 'flex';
        loginError.style.display = 'none';
        showPage('dashboard');
      } else {
        loginError.style.display = 'block';
        loginPasswordEl.value = '';
        loginPasswordEl.focus();
      }
    }

    // ============================================
    // NAVIGAZIONE SIDEBAR
    // ============================================
    const navItems = document.querySelectorAll('.nav-item');
    const mainContent = document.getElementById('mainContent');
    const sidebarEl = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    // ═══ MODIFICA 2/4: Rimosso "agenda" dai placeholder ═══
    const placeholderPages = {
      template: { title: 'Template', subtitle: 'Modelli WhatsApp ed Email' },
      impostazioni: { title: 'Impostazioni', subtitle: 'Configura stati, fonti, corsi e altro' },
      report: { title: 'Report', subtitle: 'Statistiche e estrazioni' }
    };

    navItems.forEach(item => {
      item.addEventListener('click', () => {
        navItems.forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        showPage(item.dataset.page);
        sidebarEl.classList.remove('open');
        sidebarOverlay.classList.remove('open');
      });
    });

    function showPage(page) {
      pageVersion++;
      currentPage = page;

      closeLeadPanel();
      closeModal('importModal');
      closeModal('deleteModal');

      if (leadUnsubscribe && page !== 'lead') {
        leadUnsubscribe();
        leadUnsubscribe = null;
      }

      // ═══ MODIFICA 3/4: Pulizia listener agenda ═══
      if (agendaUnsub && page !== 'agenda') {
        agendaUnsub();
        agendaUnsub = null;
      }

      if (page === 'dashboard') {
        renderDashboard();
      } else if (page === 'lead') {
        renderLeadPage();
      // ═══ MODIFICA 4/4: Routing pagina agenda ═══
      } else if (page === 'agenda') {
        renderAgendaPage();
      } else {
        const data = placeholderPages[page];
        mainContent.innerHTML = `
          <div class="page-header">
            <h1 class="page-title">${data.title}</h1>
            <p class="page-subtitle">${data.subtitle}</p>
          </div>
          <div class="card">
            <p style="color: var(--text-secondary);">Il modulo ${data.title} verrà costruito in una chat dedicata.</p>
          </div>
        `;
      }
    }

    // ============================================
    // MOBILE: HAMBURGER MENU
    // ============================================
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    hamburgerBtn.addEventListener('click', () => {
      sidebarEl.classList.toggle('open');
      sidebarOverlay.classList.toggle('open');
    });
    sidebarOverlay.addEventListener('click', () => {
      sidebarEl.classList.remove('open');
      sidebarOverlay.classList.remove('open');
    });

    // ============================================
    // TOAST
    // ============================================
    function showToast(msg, type = 'info') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `toast toast-${type} show`;
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    // ============================================
    // MODALS
    // ============================================
    function openModal(id) { document.getElementById(id).classList.add('open'); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }

    // ============================================
    //
    //  DASHBOARD
    //
    // ============================================
    let currentPeriod = 'month';

    function renderDashboard() {
      const today = new Date().toLocaleDateString('it-IT', {
        weekday: 'long', day: 'numeric', month: 'long'
      });
      mainContent.innerHTML = `
        <div class="page-header">
          <h1 class="page-title">Dashboard</h1>
          <p class="page-subtitle">Panoramica generale del CRM</p>
        </div>
        <div class="filter-bar">
          <label>Periodo</label>
          <select id="periodSelect">
            <option value="month">Mese corrente</option>
            <option value="quarter">Trimestre</option>
            <option value="semester">Semestre</option>
            <option value="year">Anno</option>
            <option value="custom">Personalizzato</option>
          </select>
          <div class="custom-dates" id="customDates">
            <span style="font-size:13px;color:var(--text-secondary)">Da</span>
            <input type="date" id="dateFrom">
            <span style="font-size:13px;color:var(--text-secondary)">A</span>
            <input type="date" id="dateTo">
          </div>
        </div>
        <div class="counters-grid">
          <div class="counter-card">
            <div class="counter-icon" style="background:var(--primary-light)">
              <svg viewBox="0 0 24 24" stroke="#1e40af"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            </div>
            <div class="counter-info">
              <div class="counter-number" id="counterTotal"><div class="spinner"></div></div>
              <div class="counter-label">Lead Totali</div>
            </div>
          </div>
          <div class="counter-card">
            <div class="counter-icon" style="background:var(--pink-light)">
              <svg viewBox="0 0 24 24" stroke="#db2777"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            </div>
            <div class="counter-info">
              <div class="counter-number" id="counterAppointments"><div class="spinner"></div></div>
              <div class="counter-label">Appuntamenti Oggi</div>
            </div>
          </div>
          <div class="counter-card">
            <div class="counter-icon" style="background:var(--green-light)">
              <svg viewBox="0 0 24 24" stroke="#16a34a"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </div>
            <div class="counter-info">
              <div class="counter-number" id="counterContracts"><div class="spinner"></div></div>
              <div class="counter-label">Contratti Firmati</div>
            </div>
          </div>
          <div class="counter-card">
            <div class="counter-icon" style="background:var(--orange-light)">
              <svg viewBox="0 0 24 24" stroke="#d97706"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
            </div>
            <div class="counter-info">
              <div class="counter-number" id="counterEnrolled"><div class="spinner"></div></div>
              <div class="counter-label">Iscritti</div>
            </div>
          </div>
          <div class="counter-card">
            <div class="counter-icon" style="background:var(--orange-light)">
              <svg viewBox="0 0 24 24" stroke="#d97706"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            </div>
            <div class="counter-info">
              <div class="counter-number" id="counterNew"><div class="spinner"></div></div>
              <div class="counter-label">Nuovi Lead</div>
            </div>
          </div>
        </div>
        <div class="sections-grid">
          <div class="section-card">
            <div class="section-card-header"><h3>Clienti Recenti</h3><span>Ultimi 10</span></div>
            <div class="section-card-body" id="recentClients"><div style="display:flex;justify-content:center;padding:30px;"><div class="spinner"></div></div></div>
          </div>
          <div class="section-card">
            <div class="section-card-header"><h3>Appuntamenti Oggi</h3><span>${today}</span></div>
            <div class="section-card-body" id="todayAppointments"><div style="display:flex;justify-content:center;padding:30px;"><div class="spinner"></div></div></div>
          </div>
        </div>
      `;
      const periodSelect = document.getElementById('periodSelect');
      const customDates = document.getElementById('customDates');
      periodSelect.value = currentPeriod;
      if (currentPeriod === 'custom') customDates.classList.add('visible');
      periodSelect.addEventListener('change', () => {
        currentPeriod = periodSelect.value;
        customDates.classList.toggle('visible', currentPeriod === 'custom');
        loadDashboardData();
      });
      document.getElementById('dateFrom')?.addEventListener('change', loadDashboardData);
      document.getElementById('dateTo')?.addEventListener('change', loadDashboardData);
      loadDashboardData();
    }

    function getDateRange() {
      const now = new Date();
      if (currentPeriod === 'custom') {
        const fromEl = document.getElementById('dateFrom');
        const toEl = document.getElementById('dateTo');
        const from = fromEl?.value ? new Date(fromEl.value + 'T00:00:00') : new Date(now.getFullYear(), 0, 1);
        const to = toEl?.value ? new Date(toEl.value + 'T23:59:59') : now;
        return { from, to };
      }
      let from;
      switch (currentPeriod) {
        case 'month': from = new Date(now.getFullYear(), now.getMonth(), 1); break;
        case 'quarter': from = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1); break;
        case 'semester': from = now.getMonth() < 6 ? new Date(now.getFullYear(), 0, 1) : new Date(now.getFullYear(), 6, 1); break;
        case 'year': from = new Date(now.getFullYear(), 0, 1); break;
        default: from = new Date(now.getFullYear(), now.getMonth(), 1);
      }
      return { from, to: now };
    }

    async function loadDashboardData() {
      const myVersion = pageVersion;
      await Promise.all([
        loadCounters(myVersion),
        loadRecentClients(myVersion),
        loadTodayAppointments(myVersion)
      ]);
    }

    async function loadCounters(myVersion) {
      const { from, to } = getDateRange();
      try {
        const leadsSnap = await getDocs(collection(db, 'leads'));
        if (pageVersion !== myVersion) return;

        let totalLeads = 0, newLeads = 0, contratti = 0, iscritti = 0;
        leadsSnap.forEach(docSnap => {
          const d = docSnap.data();
          const created = d.dataCreazione?.toDate ? d.dataCreazione.toDate() : null;
          if (created && created >= from && created <= to) {
            totalLeads++;
            if (d.stato === 'Nuovo') newLeads++;
            if (d.stato === 'Contratto Firmato') contratti++;
            if (d.stato === 'Iscritto') iscritti++;
          }
        });

        const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
        const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
        const appSnap = await getDocs(collection(db, 'appuntamenti'));
        if (pageVersion !== myVersion) return;

        let appOggi = 0;
        appSnap.forEach(docSnap => {
          const d = docSnap.data();
          const dt = d.data?.toDate ? d.data.toDate() : null;
          if (dt && dt >= todayStart && dt <= todayEnd) appOggi++;
        });

        setCounter('counterTotal', totalLeads);
        setCounter('counterAppointments', appOggi);
        setCounter('counterContracts', contratti);
        setCounter('counterEnrolled', iscritti);
        setCounter('counterNew', newLeads);
      } catch (err) {
        console.error('Errore contatori:', err);
        if (pageVersion !== myVersion) return;
        ['counterTotal', 'counterAppointments', 'counterContracts', 'counterEnrolled', 'counterNew']
          .forEach(id => setCounter(id, '–'));
      }
    }

    function setCounter(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    async function loadRecentClients(myVersion) {
      const container = document.getElementById('recentClients');
      if (!container) return;
      try {
        const q2 = query(collection(db, 'leads'), orderBy('dataCreazione', 'desc'), limit(10));
        const snap = await getDocs(q2);
        if (pageVersion !== myVersion) return;

        if (snap.empty) {
          container.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><p>Nessun lead ancora</p></div>`;
          return;
        }
        const statiMap = await loadStatiColors();
        if (pageVersion !== myVersion) return;

        let html = '';
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const nome = `${d.nome || ''} ${d.cognome || ''}`.trim() || 'Senza nome';
          const data = d.dataCreazione?.toDate ? d.dataCreazione.toDate().toLocaleDateString('it-IT', { day: '2-digit', month: 'short' }) : '';
          const stato = d.stato || 'Nuovo';
          const fonte = d.fonte || '—';
          const colore = statiMap[stato] || '#64748b';
          html += `<div class="section-row" data-id="${docSnap.id}"><div class="section-row-left"><div class="section-row-name">${nome}</div><div class="section-row-detail">${fonte} · ${data}</div></div><div class="section-row-right"><span class="badge" style="background:${colore}18;color:${colore}">${stato}</span></div></div>`;
        });
        container.innerHTML = html;
        container.querySelectorAll('.section-row').forEach(row => {
          row.addEventListener('click', () => openLeadDetail(row.dataset.id));
        });
      } catch (err) {
        console.error('Errore lead recenti:', err);
        if (pageVersion !== myVersion) return;
        if (container) container.innerHTML = '<div class="empty-state"><p>Errore nel caricamento</p></div>';
      }
    }

    async function loadTodayAppointments(myVersion) {
      const container = document.getElementById('todayAppointments');
      if (!container) return;
      try {
        const snap = await getDocs(collection(db, 'appuntamenti'));
        if (pageVersion !== myVersion) return;

        const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
        const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
        const todayArr = [];
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const dt = d.data?.toDate ? d.data.toDate() : null;
          if (dt && dt >= todayStart && dt <= todayEnd) todayArr.push({ id: docSnap.id, ...d, _date: dt });
        });
        todayArr.sort((a, b) => a._date - b._date);
        if (todayArr.length === 0) {
          container.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><p>Nessun appuntamento oggi</p></div>`;
          return;
        }
        let html = '';
        todayArr.forEach(app => {
          const ora = app.ora || app._date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
          const nome = `${app.leadNome || ''} ${app.leadCognome || ''}`.trim() || '—';
          const tipo = app.tipo || 'nuovo';
          const tipoColor = tipo === 'richiamo' ? 'var(--orange)' : 'var(--primary)';
          const tipoLabel = tipo === 'richiamo' ? 'Richiamo' : 'Nuovo';
          html += `<div class="section-row"><div class="section-row-left"><div class="section-row-name">${nome}</div><div class="section-row-detail">${app.descrizione || ''}</div></div><div class="section-row-right"><span style="font-size:13px;font-weight:600;color:var(--text)">${ora}</span><span class="badge" style="background:${tipoColor}18;color:${tipoColor}">${tipoLabel}</span></div></div>`;
        });
        container.innerHTML = html;
      } catch (err) {
        console.error('Errore appuntamenti:', err);
        if (pageVersion !== myVersion) return;
        if (container) container.innerHTML = '<div class="empty-state"><p>Errore nel caricamento</p></div>';
      }
    }

    async function loadStatiColors() {
      const map = { 'Nuovo': '#22c55e' };
      try {
        const snap = await getDocs(collection(db, 'impostazioni', 'stati', 'items'));
        snap.forEach(docSnap => {
          const d = docSnap.data();
          if (d.nome && d.colore) map[d.nome] = d.colore;
        });
      } catch (e) { console.warn('Stati non caricati, uso default'); }
      return map;
    }

    // ============================================
    //
    //  MODULO LEAD
    //
    // ============================================

    let allLeads = [];
    let allStati = [];
    let allFonti = [];
    let leadCurrentView = 'kanban';
    let selectedLeads = new Set();
    let leadImportData = [];
    let leadSortField = 'dataCreazione';
    let leadSortDir = 'desc';
    let deleteCallback = null;

    async function loadLeadStati() {
      try {
        const snap = await getDocs(query(collection(db, 'impostazioni', 'stati', 'items'), orderBy('posizione')));
        allStati = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) {
        console.warn('Errore caricamento stati:', e);
        allStati = [{ id: 'default', nome: 'Nuovo', colore: '#22c55e', posizione: 0 }];
      }
    }

    async function loadLeadFonti() {
      try {
        const snap = await getDocs(query(collection(db, 'impostazioni', 'fonti', 'items'), orderBy('posizione')));
        allFonti = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) {
        console.warn('Errore caricamento fonti:', e);
        allFonti = [];
      }
    }

    async function renderLeadPage() {
      const myVersion = pageVersion;
      mainContent.innerHTML = `<div style="display:flex;justify-content:center;padding:60px;"><div class="spinner"></div></div>`;
      await loadLeadStati();
      await loadLeadFonti();
      if (pageVersion !== myVersion) return;

      const fontiOptions = allFonti.map(f => `<option value="${f.nome}">${f.nome}</option>`).join('');
      const statiOptions = allStati.map(s => `<option value="${s.nome}">${s.nome}</option>`).join('');

      mainContent.innerHTML = `
        <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
          <div>
            <h1 class="page-title">Lead</h1>
            <p class="page-subtitle">Gestione contatti e pipeline</p>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-secondary" id="btnDownloadTemplate">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Scarica Template
            </button>
            <button class="btn btn-secondary" id="btnImportExcel">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Importa da Excel
            </button>
            <button class="btn btn-primary" id="btnNewLead" style="width:auto;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Nuovo Lead
            </button>
          </div>
        </div>
        <div class="filter-bar" style="margin-bottom:16px;">
          <select id="leadFilterPeriodo">
            <option value="mese">Mese corrente</option>
            <option value="trimestre">Trimestre</option>
            <option value="semestre">Semestre</option>
            <option value="anno">Anno</option>
            <option value="tutti">Tutti</option>
            <option value="personalizzato">Personalizzato</option>
          </select>
          <div class="custom-dates" id="leadDateRange">
            <span style="font-size:13px;color:var(--text-secondary)">Da</span>
            <input type="date" id="leadFilterDa">
            <span style="font-size:13px;color:var(--text-secondary)">A</span>
            <input type="date" id="leadFilterA">
          </div>
          <select id="leadFilterFonte">
            <option value="">Tutte le fonti</option>
            ${fontiOptions}
          </select>
          <select id="leadFilterStato">
            <option value="">Tutti gli stati</option>
            ${statiOptions}
          </select>
          <input type="text" id="leadSearchInput" placeholder="Cerca nome, cognome, telefono, email..." style="min-width:200px;padding:8px 12px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:14px;font-family:var(--font);color:var(--text);outline:none;">
          <div class="lead-view-toggle" style="margin-left:auto;">
            <button class="active" id="btnViewKanban">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="3" width="5" height="12" rx="1"/><rect x="17" y="3" width="5" height="15" rx="1"/></svg>
              Kanban
            </button>
            <button id="btnViewElenco">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
              Elenco
            </button>
          </div>
        </div>
        <div class="lead-bulk-bar" id="leadBulkBar">
          <span id="leadBulkCount">0 selezionati</span>
          <button class="btn btn-red" style="padding:6px 14px;font-size:12px;" id="btnDeleteSelected">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            Elimina selezionati
          </button>
        </div>
        <div class="lead-kanban" id="leadKanban"></div>
        <div class="lead-list" id="leadList" style="display:none;">
          <table class="lead-table">
            <thead>
              <tr>
                <th style="width:40px;text-align:center;"><input type="checkbox" id="leadSelectAll"></th>
                <th data-sort="nome">Nome <span class="sort-arrow">↕</span></th>
                <th data-sort="cognome">Cognome <span class="sort-arrow">↕</span></th>
                <th data-sort="telefono">Telefono <span class="sort-arrow">↕</span></th>
                <th data-sort="email">Email <span class="sort-arrow">↕</span></th>
                <th data-sort="fonte">Fonte <span class="sort-arrow">↕</span></th>
                <th data-sort="stato">Stato <span class="sort-arrow">↕</span></th>
                <th data-sort="dataCreazione">Data <span class="sort-arrow">↕</span></th>
              </tr>
            </thead>
            <tbody id="leadListBody"></tbody>
          </table>
        </div>
      `;

      if (pageVersion !== myVersion) return;

      document.getElementById('btnNewLead').addEventListener('click', openNewLead);
      document.getElementById('btnImportExcel').addEventListener('click', () => openModal('importModal'));
      document.getElementById('btnDownloadTemplate').addEventListener('click', downloadTemplate);
      document.getElementById('btnDeleteSelected').addEventListener('click', deleteSelectedLeads);
      document.getElementById('leadFilterPeriodo').addEventListener('change', function () {
        document.getElementById('leadDateRange').classList.toggle('visible', this.value === 'personalizzato');
        renderLeadView();
      });
      document.getElementById('leadFilterFonte').addEventListener('change', renderLeadView);
      document.getElementById('leadFilterStato').addEventListener('change', renderLeadView);
      document.getElementById('leadSearchInput').addEventListener('input', renderLeadView);
      document.getElementById('leadFilterDa').addEventListener('change', renderLeadView);
      document.getElementById('leadFilterA').addEventListener('change', renderLeadView);
      document.getElementById('btnViewKanban').addEventListener('click', () => setLeadView('kanban'));
      document.getElementById('btnViewElenco').addEventListener('click', () => setLeadView('elenco'));
      document.getElementById('leadSelectAll').addEventListener('change', function () {
        const leads = getFilteredLeads();
        if (this.checked) leads.forEach(l => selectedLeads.add(l.id));
        else selectedLeads.clear();
        updateBulkBar();
        renderLeadView();
      });
      document.querySelectorAll('.lead-table th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          const field = th.dataset.sort;
          if (leadSortField === field) leadSortDir = leadSortDir === 'asc' ? 'desc' : 'asc';
          else { leadSortField = field; leadSortDir = 'asc'; }
          renderLeadList();
        });
      });

      leadUnsubscribe = onSnapshot(
        query(collection(db, 'leads'), orderBy('dataCreazione', 'desc')),
        (snap) => {
          if (currentPage !== 'lead') return;
          allLeads = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          renderLeadView();
        }
      );
    }

    function getFilteredLeads() {
      let leads = [...allLeads];
      const periodo = document.getElementById('leadFilterPeriodo')?.value || 'tutti';
      const now = new Date();
      let startDate = null, endDate = null;
      if (periodo === 'mese') startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      else if (periodo === 'trimestre') startDate = new Date(now.getFullYear(), now.getMonth() - 2, 1);
      else if (periodo === 'semestre') startDate = new Date(now.getFullYear(), now.getMonth() - 5, 1);
      else if (periodo === 'anno') startDate = new Date(now.getFullYear(), 0, 1);
      else if (periodo === 'personalizzato') {
        const da = document.getElementById('leadFilterDa')?.value;
        const a = document.getElementById('leadFilterA')?.value;
        if (da) startDate = new Date(da);
        if (a) { endDate = new Date(a); endDate.setHours(23, 59, 59); }
      }
      if (startDate) leads = leads.filter(l => {
        const d = l.dataCreazione?.toDate ? l.dataCreazione.toDate() : new Date(l.dataCreazione);
        return d >= startDate;
      });
      if (endDate) leads = leads.filter(l => {
        const d = l.dataCreazione?.toDate ? l.dataCreazione.toDate() : new Date(l.dataCreazione);
        return d <= endDate;
      });
      const fonte = document.getElementById('leadFilterFonte')?.value;
      if (fonte) leads = leads.filter(l => l.fonte === fonte);
      const stato = document.getElementById('leadFilterStato')?.value;
      if (stato) leads = leads.filter(l => l.stato === stato);
      const q = (document.getElementById('leadSearchInput')?.value || '').toLowerCase().trim();
      if (q) leads = leads.filter(l =>
        (l.nome || '').toLowerCase().includes(q) ||
        (l.cognome || '').toLowerCase().includes(q) ||
        (l.telefono || '').toLowerCase().includes(q) ||
        (l.email || '').toLowerCase().includes(q)
      );
      return leads;
    }

    function renderLeadView() {
      if (currentPage !== 'lead') return;
      if (leadCurrentView === 'kanban') renderLeadKanban();
      else renderLeadList();
      updateBulkBar();
    }

    function setLeadView(view) {
      leadCurrentView = view;
      document.getElementById('btnViewKanban')?.classList.toggle('active', view === 'kanban');
      document.getElementById('btnViewElenco')?.classList.toggle('active', view === 'elenco');
      const kanbanEl = document.getElementById('leadKanban');
      const listEl = document.getElementById('leadList');
      if (kanbanEl) kanbanEl.style.display = view === 'kanban' ? 'flex' : 'none';
      if (listEl) listEl.style.display = view === 'elenco' ? 'block' : 'none';
      renderLeadView();
    }

    function renderLeadKanban() {
      const container = document.getElementById('leadKanban');
      if (!container) return;
      const leads = getFilteredLeads();
      container.innerHTML = '';
      allStati.forEach(stato => {
        const colLeads = leads.filter(l => l.stato === stato.nome);
        const col = document.createElement('div');
        col.className = 'kanban-col';
        const headerBg = stato.colore + '20';
        col.innerHTML = `<div class="kanban-col-header" style="background:${headerBg}"><span class="kanban-col-title" style="color:${stato.colore}">${stato.nome}</span><span class="kanban-col-count" style="color:${stato.colore}">${colLeads.length}</span></div>`;
        const body = document.createElement('div');
        body.className = 'kanban-col-body';
        body.dataset.stato = stato.nome;
        body.addEventListener('dragover', e => { e.preventDefault(); body.classList.add('drag-over'); });
        body.addEventListener('dragleave', () => body.classList.remove('drag-over'));
        body.addEventListener('drop', e => {
          e.preventDefault();
          body.classList.remove('drag-over');
          const leadId = e.dataTransfer.getData('text/plain');
          moveLeadToStato(leadId, body.dataset.stato);
        });
        colLeads.forEach(lead => {
          const card = document.createElement('div');
          card.className = 'kanban-card';
          card.draggable = true;
          card.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', lead.id); card.classList.add('dragging'); });
          card.addEventListener('dragend', () => card.classList.remove('dragging'));
          const date = lead.dataCreazione?.toDate ? lead.dataCreazione.toDate() : new Date(lead.dataCreazione);
          const dateStr = date.toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
          const checked = selectedLeads.has(lead.id) ? 'checked' : '';
          card.innerHTML = `
            <input type="checkbox" class="kanban-card-check" ${checked}>
            <div class="kanban-card-name">${lead.nome} ${lead.cognome}</div>
            <div class="kanban-card-phone">${lead.telefono || ''}</div>
            <div class="kanban-card-meta">
              ${lead.fonte ? `<span class="kanban-card-fonte">${lead.fonte}</span>` : '<span></span>'}
              <span class="kanban-card-date">${dateStr}</span>
            </div>
          `;
          card.querySelector('.kanban-card-check').addEventListener('click', (e) => {
            e.stopPropagation();
            toggleLeadSelect(lead.id);
          });
          card.querySelector('.kanban-card-name').addEventListener('click', () => openLeadDetail(lead.id));
          body.appendChild(card);
        });
        col.appendChild(body);
        container.appendChild(col);
      });
    }

    function renderLeadList() {
      const tbody = document.getElementById('leadListBody');
      if (!tbody) return;
      let leads = getFilteredLeads();
      leads.sort((a, b) => {
        let va = a[leadSortField] || '';
        let vb = b[leadSortField] || '';
        if (leadSortField === 'dataCreazione') {
          va = va?.toDate ? va.toDate().getTime() : new Date(va).getTime();
          vb = vb?.toDate ? vb.toDate().getTime() : new Date(vb).getTime();
        }
        if (typeof va === 'string') va = va.toLowerCase();
        if (typeof vb === 'string') vb = vb.toLowerCase();
        if (va < vb) return leadSortDir === 'asc' ? -1 : 1;
        if (va > vb) return leadSortDir === 'asc' ? 1 : -1;
        return 0;
      });
      tbody.innerHTML = '';
      leads.forEach(lead => {
        const date = lead.dataCreazione?.toDate ? lead.dataCreazione.toDate() : new Date(lead.dataCreazione);
        const dateStr = date.toLocaleDateString('it-IT');
        const stato = allStati.find(s => s.nome === lead.stato);
        const badgeBg = stato ? stato.colore + '20' : '#f1f5f9';
        const badgeColor = stato ? stato.colore : '#64748b';
        const checked = selectedLeads.has(lead.id) ? 'checked' : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:center;"><input type="checkbox" ${checked} data-id="${lead.id}"></td>
          <td>${lead.nome || ''}</td>
          <td>${lead.cognome || ''}</td>
          <td>${lead.telefono || ''}</td>
          <td>${lead.email || ''}</td>
          <td>${lead.fonte || ''}</td>
          <td><span class="badge" style="background:${badgeBg};color:${badgeColor}">${lead.stato || ''}</span></td>
          <td>${dateStr}</td>
        `;
        tr.querySelector('input[type="checkbox"]').addEventListener('change', () => toggleLeadSelect(lead.id));
        tr.addEventListener('click', e => {
          if (e.target.type === 'checkbox') return;
          openLeadDetail(lead.id);
        });
        tbody.appendChild(tr);
      });
    }

    function toggleLeadSelect(id) {
      if (selectedLeads.has(id)) selectedLeads.delete(id);
      else selectedLeads.add(id);
      updateBulkBar();
      renderLeadView();
    }

    function updateBulkBar() {
      const bar = document.getElementById('leadBulkBar');
      if (!bar) return;
      const count = selectedLeads.size;
      const countEl = document.getElementById('leadBulkCount');
      if (countEl) countEl.textContent = `${count} selezionat${count === 1 ? 'o' : 'i'}`;
      bar.classList.toggle('visible', count > 0);
    }

    async function moveLeadToStato(leadId, newStato) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead || lead.stato === newStato) return;
      const oldStato = lead.stato;
      await updateDoc(doc(db, 'leads', leadId), { stato: newStato });
      await addDoc(collection(db, 'leads', leadId, 'storicoStati'), {
        statoPrecedente: oldStato,
        statoNuovo: newStato,
        data: serverTimestamp(),
        origine: 'Cambio manuale'
      });
      showToast(`Stato: ${oldStato} → ${newStato}`, 'success');
    }

    const leadOverlay = document.getElementById('leadOverlay');
    const leadPanel = document.getElementById('leadPanel');
    const leadPanelClose = document.getElementById('leadPanelClose');

    leadOverlay.addEventListener('click', closeLeadPanel);
    leadPanelClose.addEventListener('click', closeLeadPanel);

    function openLeadPanel() {
      document.getElementById('leadOverlay').classList.add('open');
      document.getElementById('leadPanel').classList.add('open');
    }

    function closeLeadPanel() {
      document.getElementById('leadOverlay')?.classList.remove('open');
      document.getElementById('leadPanel')?.classList.remove('open');
      currentLeadId = null;
    }

    function openNewLead() {
      window.location.href = 'lead-detail.html?id=new';
    }

    function openLeadDetail(id) {
      window.location.href = 'lead-detail.html?id=' + id;
    }

    async function saveLead() {
      const nome = document.getElementById('fNome')?.value.trim();
      const cognome = document.getElementById('fCognome')?.value.trim();
      const telefono = document.getElementById('fTelefono')?.value.trim();
      if (!nome || !cognome || !telefono) {
        showToast('Nome, Cognome e Telefono sono obbligatori', 'error');
        return;
      }
      const data = {
        nome, cognome, telefono,
        email: document.getElementById('fEmail')?.value.trim() || '',
        fonte: document.getElementById('fFonte')?.value || '',
        priorita: document.getElementById('fPriorita')?.value || '',
        provincia: document.getElementById('fProvincia')?.value.trim() || '',
        isMinore: document.getElementById('fIsMinore')?.value === 'true',
        note: document.getElementById('fNote')?.value.trim() || '',
      };
      if (data.isMinore) {
        data.genitore = {
          nome: document.getElementById('fGenNome')?.value.trim() || '',
          cognome: document.getElementById('fGenCognome')?.value.trim() || '',
          telefono: document.getElementById('fGenTelefono')?.value.trim() || '',
          email: document.getElementById('fGenEmail')?.value.trim() || '',
        };
      }
      try {
        if (currentLeadId) {
          await updateDoc(doc(db, 'leads', currentLeadId), data);
          showToast('Lead aggiornato!', 'success');
        } else {
          data.stato = 'Nuovo';
          data.dataCreazione = serverTimestamp();
          const ref = await addDoc(collection(db, 'leads'), data);
          await addDoc(collection(db, 'leads', ref.id, 'storicoStati'), {
            statoPrecedente: null, statoNuovo: 'Nuovo',
            data: serverTimestamp(), origine: 'Creazione manuale'
          });
          showToast('Lead creato!', 'success');
        }
        closeLeadPanel();
      } catch (err) {
        console.error(err);
        showToast('Errore nel salvataggio', 'error');
      }
    }

    function deleteSelectedLeads() {
      const count = selectedLeads.size;
      if (count === 0) return;
      document.getElementById('deleteMessage').textContent = `Sei sicuro di voler eliminare ${count} lead? Questa azione è irreversibile.`;
      deleteCallback = async () => {
        for (const id of selectedLeads) {
          await deleteDoc(doc(db, 'leads', id));
        }
        selectedLeads.clear();
        updateBulkBar();
        showToast(`${count} lead eliminati`, 'info');
      };
      openModal('deleteModal');
    }

    document.getElementById('deleteCancelBtn').addEventListener('click', () => closeModal('deleteModal'));
    document.getElementById('deleteConfirmBtn').addEventListener('click', async () => {
      if (deleteCallback) await deleteCallback();
      deleteCallback = null;
      closeModal('deleteModal');
    });

    const dropzone = document.getElementById('dropzone');
    const importFileInput = document.getElementById('importFileInput');

    dropzone.addEventListener('click', () => importFileInput.click());
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', e => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      if (e.dataTransfer.files[0]) parseExcel(e.dataTransfer.files[0]);
    });
    importFileInput.addEventListener('change', () => {
      if (importFileInput.files[0]) parseExcel(importFileInput.files[0]);
    });
    document.getElementById('importCancelBtn').addEventListener('click', () => {
      closeModal('importModal');
      resetImport();
    });
    document.getElementById('importConfirmBtn').addEventListener('click', confirmImport);

    function parseExcel(file) {
      document.getElementById('importFileName').textContent = file.name;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const wb = XLSX.read(e.target.result, { type: 'binary' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, { defval: '' });
          leadImportData = [];
          let errors = 0;
          const previewBody = document.getElementById('previewBody');
          previewBody.innerHTML = '';
          json.forEach((row, i) => {
            const nome = (row['Nome'] || row['nome'] || '').toString().trim();
            const cognome = (row['Cognome'] || row['cognome'] || '').toString().trim();
            const telefono = (row['Telefono'] || row['telefono'] || '').toString().trim();
            const email = (row['Email'] || row['email'] || '').toString().trim();
            const fonte = (row['Fonte'] || row['fonte'] || '').toString().trim();
            const note = (row['Note'] || row['note'] || '').toString().trim();
            const valid = nome && cognome && telefono;
            if (!valid) errors++;
            leadImportData.push({ nome, cognome, telefono, email, fonte, note, valid });
            const tr = document.createElement('tr');
            if (!valid) tr.className = 'error-row';
            tr.innerHTML = `<td>${i + 1}</td><td>${nome || '<em style="color:var(--red)">mancante</em>'}</td><td>${cognome || '<em style="color:var(--red)">mancante</em>'}</td><td>${telefono || '<em style="color:var(--red)">mancante</em>'}</td><td>${email}</td><td>${fonte}</td><td>${note}</td><td>${valid ? '✓' : '<span style="color:var(--red)">✗</span>'}</td>`;
            previewBody.appendChild(tr);
          });
          document.getElementById('importErrors').textContent = errors > 0 ? `${errors} righe con errori (verranno saltate)` : '';
          document.getElementById('importStep1').style.display = 'none';
          document.getElementById('importStep2').style.display = 'block';
          document.getElementById('importConfirmBtn').style.display = 'inline-flex';
        } catch (err) {
          showToast('Errore nella lettura del file', 'error');
          console.error(err);
        }
      };
      reader.readAsBinaryString(file);
    }

    async function confirmImport() {
      const validRows = leadImportData.filter(r => r.valid);
      if (validRows.length === 0) { showToast('Nessuna riga valida', 'error'); return; }
      try {
        for (const row of validRows) {
          const ref = await addDoc(collection(db, 'leads'), {
            nome: row.nome, cognome: row.cognome, telefono: row.telefono,
            email: row.email, fonte: row.fonte, note: row.note,
            stato: 'Nuovo', dataCreazione: serverTimestamp()
          });
          await addDoc(collection(db, 'leads', ref.id, 'storicoStati'), {
            statoPrecedente: null, statoNuovo: 'Nuovo',
            data: serverTimestamp(), origine: 'Import Excel'
          });
        }
        showToast(`${validRows.length} lead importati!`, 'success');
        closeModal('importModal');
        resetImport();
      } catch (err) {
        showToast('Errore durante l\'import', 'error');
        console.error(err);
      }
    }

    function resetImport() {
      leadImportData = [];
      document.getElementById('importStep1').style.display = 'block';
      document.getElementById('importStep2').style.display = 'none';
      document.getElementById('importConfirmBtn').style.display = 'none';
      importFileInput.value = '';
    }

    function downloadTemplate() {
      const data = [{ Nome: 'Mario', Cognome: 'Rossi', Telefono: '3331234567', Email: 'mario@email.com', Fonte: 'Sito Web', Note: 'Interessato al corso AFM' }];
      const ws = XLSX.utils.json_to_sheet(data);
      ws['!cols'] = [{ wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 25 }, { wch: 15 }, { wch: 30 }];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Template Lead');
      XLSX.writeFile(wb, 'Template_Import_Lead.xlsx');
    }

    // ============================================
    //
    //  MODULO AGENDA CALENDARIO
    //
    // ============================================

    let agendaView = 'month';
    let agendaDate = new Date();
    let agendaAppointments = [];
    let agendaLeads = [];
    let agendaUnsub = null;

    const AG_MONTHS = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
    const AG_DAYS = ['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato'];

    async function renderAgendaPage() {
      const myVersion = pageVersion;
      try {
        const snap = await getDocs(collection(db, 'leads'));
        if (pageVersion !== myVersion) return;
        agendaLeads = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch(e) { console.error('Errore leads agenda:', e); }
      if (pageVersion !== myVersion) return;

      mainContent.innerHTML = `
        <div class="agenda-header">
          <div>
            <h1 class="page-title">Agenda Calendario</h1>
            <p class="page-subtitle">Appuntamenti e richiami</p>
          </div>
          <div class="agenda-controls">
            <div class="agenda-legend">
              <div class="agenda-legend-item"><div class="agenda-legend-dot blue"></div>Nuovo</div>
              <div class="agenda-legend-item"><div class="agenda-legend-dot orange"></div>Richiamo</div>
            </div>
            <div class="agenda-nav">
              <button class="agenda-nav-btn" id="agNavPrev"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
              <button class="agenda-today-btn" id="agNavToday">Oggi</button>
              <button class="agenda-nav-btn" id="agNavNext"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
            </div>
            <div class="agenda-period" id="agPeriod"></div>
            <div class="agenda-view-toggle">
              <button class="agenda-view-btn active" data-agview="month">Mese</button>
              <button class="agenda-view-btn" data-agview="week">Settimana</button>
              <button class="agenda-view-btn" data-agview="day">Giorno</button>
            </div>
            <button class="btn btn-primary" style="width:auto;" id="agNewAppt">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Nuovo Appuntamento
            </button>
          </div>
        </div>
        <div id="agCalendar"></div>
        <div class="agenda-modal-overlay" id="agModalCreate">
          <div class="agenda-modal">
            <div class="agenda-modal-hd"><h3 id="agModalTitle">Nuovo Appuntamento</h3><button class="agenda-modal-close" onclick="document.getElementById('agModalCreate').classList.remove('open')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
            <div class="agenda-modal-body">
              <input type="hidden" id="agEditId">
              <div class="ag-form-row"><div class="ag-form-group"><label class="ag-form-label">Data *</label><input type="date" class="form-control" id="agData"></div><div class="ag-form-group"><label class="ag-form-label">Ora *</label><input type="time" class="form-control" id="agOra"></div></div>
              <div class="ag-form-row"><div class="ag-form-group"><label class="ag-form-label">Tipo *</label><select class="form-control" id="agTipo"><option value="nuovo">Nuovo Appuntamento</option><option value="richiamo">Richiamo</option></select></div><div class="ag-form-group"><label class="ag-form-label">Lead Associato</label><div class="ag-lead-search"><input type="text" class="form-control" id="agLeadSearch" placeholder="Cerca nome..." autocomplete="off"><input type="hidden" id="agLeadId"><input type="hidden" id="agLeadNome"><input type="hidden" id="agLeadCognome"><div class="ag-lead-results" id="agLeadResults"></div></div></div></div>
              <div class="ag-form-row full"><div class="ag-form-group"><label class="ag-form-label">Descrizione</label><textarea class="form-control" id="agDescrizione" rows="3" placeholder="Note..."></textarea></div></div>
            </div>
            <div class="agenda-modal-ft"><button class="btn btn-secondary" onclick="document.getElementById('agModalCreate').classList.remove('open')">Annulla</button><button class="btn btn-primary" style="background:var(--green);width:auto;" id="agSaveBtn">Salva</button></div>
          </div>
        </div>
        <div class="agenda-modal-overlay" id="agModalDetail">
          <div class="agenda-modal">
            <div class="agenda-modal-hd"><h3>Dettaglio Appuntamento</h3><button class="agenda-modal-close" onclick="document.getElementById('agModalDetail').classList.remove('open')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
            <div class="agenda-modal-body" id="agDetailBody"></div>
            <div class="agenda-modal-ft" id="agDetailFt"></div>
          </div>
        </div>
      `;
      if (pageVersion !== myVersion) return;

      document.getElementById('agNavPrev').addEventListener('click', function(){ agNavigate(-1); });
      document.getElementById('agNavNext').addEventListener('click', function(){ agNavigate(1); });
      document.getElementById('agNavToday').addEventListener('click', function(){ agendaDate = new Date(); agRender(); });
      document.getElementById('agNewAppt').addEventListener('click', function(){ agOpenCreate(); });
      document.getElementById('agSaveBtn').addEventListener('click', agSaveAppt);
      document.querySelectorAll('.agenda-view-btn').forEach(function(btn){ btn.addEventListener('click', function(){ agendaView=btn.dataset.agview; document.querySelectorAll('.agenda-view-btn').forEach(function(b){b.classList.remove('active');}); btn.classList.add('active'); agRender(); }); });

      var agSearchInput = document.getElementById('agLeadSearch');
      var agResultsDiv = document.getElementById('agLeadResults');
      agSearchInput.addEventListener('input', function(){
        var q = agSearchInput.value.toLowerCase().trim();
        if(q.length<2){agResultsDiv.classList.remove('show');return;}
        var matches = agendaLeads.filter(function(l){ return (l.nome&&l.nome.toLowerCase().includes(q))||(l.cognome&&l.cognome.toLowerCase().includes(q))||((l.nome+' '+l.cognome).toLowerCase().includes(q)); }).slice(0,8);
        if(!matches.length){ agResultsDiv.innerHTML='<div class="ag-lead-result-item" style="color:var(--text-secondary)">Nessun lead trovato</div>'; }
        else { agResultsDiv.innerHTML=matches.map(function(l){ var ini=((l.nome||'?')[0]+(l.cognome||'?')[0]).toUpperCase(); return '<div class="ag-lead-result-item" data-lid="'+l.id+'" data-ln="'+(l.nome||'')+'" data-lc="'+(l.cognome||'')+'">'+'<div class="ag-lead-avatar">'+ini+'</div>'+(l.nome||'')+' '+(l.cognome||'')+(l.telefono?' <span style="color:var(--text-secondary);font-size:11px">&middot; '+l.telefono+'</span>':'')+'</div>'; }).join('');
          agResultsDiv.querySelectorAll('.ag-lead-result-item[data-lid]').forEach(function(item){ item.addEventListener('click',function(){ document.getElementById('agLeadId').value=item.dataset.lid; document.getElementById('agLeadNome').value=item.dataset.ln; document.getElementById('agLeadCognome').value=item.dataset.lc; agSearchInput.value=(item.dataset.ln+' '+item.dataset.lc).trim(); agResultsDiv.classList.remove('show'); }); });
        }
        agResultsDiv.classList.add('show');
      });
      document.addEventListener('click',function(e){ if(!e.target.closest('.ag-lead-search')) agResultsDiv.classList.remove('show'); });

      if(agendaUnsub) agendaUnsub();
      agendaUnsub = onSnapshot(collection(db,'appuntamenti'),function(snap){ if(currentPage!=='agenda')return; agendaAppointments=snap.docs.map(function(d){return{id:d.id,...d.data()};}); agRender(); });
      agRender();
    }

    function agNavigate(dir){ if(agendaView==='month')agendaDate.setMonth(agendaDate.getMonth()+dir); else if(agendaView==='week')agendaDate.setDate(agendaDate.getDate()+7*dir); else agendaDate.setDate(agendaDate.getDate()+dir); agRender(); }

    function agRender(){ agUpdatePeriod(); var c=document.getElementById('agCalendar'); if(!c)return; if(agendaView==='month')agRenderMonth(c); else if(agendaView==='week')agRenderWeek(c); else agRenderDay(c); }

    function agUpdatePeriod(){ var el=document.getElementById('agPeriod'); if(!el)return; if(agendaView==='month') el.textContent=AG_MONTHS[agendaDate.getMonth()]+' '+agendaDate.getFullYear(); else if(agendaView==='week'){ var s=agWeekStart(agendaDate),e=new Date(s);e.setDate(e.getDate()+6); el.textContent=s.getDate()+' '+AG_MONTHS[s.getMonth()].substring(0,3)+' – '+e.getDate()+' '+AG_MONTHS[e.getMonth()].substring(0,3)+' '+e.getFullYear(); } else el.textContent=AG_DAYS[agendaDate.getDay()]+' '+agendaDate.getDate()+' '+AG_MONTHS[agendaDate.getMonth()]+' '+agendaDate.getFullYear(); }

    function agRenderMonth(c){ var y=agendaDate.getFullYear(),m=agendaDate.getMonth(); var first=new Date(y,m,1),last=new Date(y,m+1,0); var startDow=first.getDay()-1;if(startDow<0)startDow=6; var todayStr=agFmt(new Date()); var h='<div class="cal-card"><div class="cal-weekdays">'; ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'].forEach(function(d){h+='<div class="cal-weekday">'+d+'</div>';}); h+='</div><div class="cal-grid">'; var prevLast=new Date(y,m,0); for(var i=startDow-1;i>=0;i--){var d=prevLast.getDate()-i;var ds=agFmt(new Date(y,m-1,d)); h+='<div class="cal-day other-month" data-date="'+ds+'"><div class="cal-day-num">'+d+'</div><div class="cal-day-events">'+agMonthEvts(ds)+'</div></div>';} for(var d=1;d<=last.getDate();d++){var ds=agFmt(new Date(y,m,d));var cls=ds===todayStr?' today':''; h+='<div class="cal-day'+cls+'" data-date="'+ds+'"><div class="cal-day-num">'+d+'</div><div class="cal-day-events">'+agMonthEvts(ds)+'</div></div>';} var total=startDow+last.getDate();var rem=total%7===0?0:7-(total%7); for(var d=1;d<=rem;d++){var ds=agFmt(new Date(y,m+1,d)); h+='<div class="cal-day other-month" data-date="'+ds+'"><div class="cal-day-num">'+d+'</div><div class="cal-day-events">'+agMonthEvts(ds)+'</div></div>';} h+='</div></div>'; c.innerHTML=h;
      c.querySelectorAll('.cal-day').forEach(function(cell){ cell.addEventListener('click',function(e){ if(e.target.closest('.cal-evt')||e.target.closest('.cal-day-more'))return; agendaDate=new Date(cell.dataset.date+'T00:00:00'); agendaView='day'; document.querySelectorAll('.agenda-view-btn').forEach(function(b){b.classList.remove('active');}); document.querySelector('[data-agview="day"]').classList.add('active'); agRender(); }); });
      c.querySelectorAll('.cal-evt').forEach(function(evt){ evt.addEventListener('click',function(e){e.stopPropagation();agOpenDetail(evt.dataset.id);}); });
      c.querySelectorAll('.cal-day-more').forEach(function(more){ more.addEventListener('click',function(e){e.stopPropagation(); agendaDate=new Date(more.closest('.cal-day').dataset.date+'T00:00:00'); agendaView='day'; document.querySelectorAll('.agenda-view-btn').forEach(function(b){b.classList.remove('active');}); document.querySelector('[data-agview="day"]').classList.add('active'); agRender(); }); });
    }

    function agMonthEvts(ds){ var list=agendaAppointments.filter(function(a){return a.data===ds;}).sort(function(a,b){return(a.ora||'').localeCompare(b.ora||'');}); if(!list.length)return''; var h=''; list.slice(0,3).forEach(function(a){var nome=agName(a); h+='<div class="cal-evt tipo-'+a.tipo+'" data-id="'+a.id+'" title="'+(a.ora||'')+' - '+nome+'">'+(a.ora?a.ora.substring(0,5)+' ':'')+nome+'</div>';}); if(list.length>3)h+='<div class="cal-day-more">+'+(list.length-3)+' altri</div>'; return h; }

    function agRenderWeek(c){ var start=agWeekStart(agendaDate);var todayStr=agFmt(new Date());var hours=agHours();var dayNames=['LUN','MAR','MER','GIO','VEN','SAB','DOM']; var h='<div class="week-wrap"><div class="week-times">'; hours.forEach(function(hr){h+='<div class="week-time">'+hr+'</div>';}); h+='</div><div class="week-cols">'; for(var i=0;i<7;i++){var day=new Date(start);day.setDate(day.getDate()+i);var ds=agFmt(day);var isToday=ds===todayStr;var dayAppts=agendaAppointments.filter(function(a){return a.data===ds;}); h+='<div class="week-col"><div class="week-col-hd'+(isToday?' today-hd':'')+'" data-date="'+ds+'"><div class="week-col-hd-name">'+dayNames[i]+'</div><div class="week-col-hd-num">'+day.getDate()+'</div></div><div class="week-slots" data-date="'+ds+'">'; hours.forEach(function(){h+='<div class="week-hour-line"></div>';}); if(isToday)h+=agNowLine(); dayAppts.forEach(function(a){h+=agWeekEvt(a);}); h+='</div></div>';} h+='</div></div>'; c.innerHTML=h;
      c.querySelectorAll('.week-col-hd').forEach(function(hd){hd.addEventListener('click',function(){agendaDate=new Date(hd.dataset.date+'T00:00:00');agendaView='day';document.querySelectorAll('.agenda-view-btn').forEach(function(b){b.classList.remove('active');});document.querySelector('[data-agview="day"]').classList.add('active');agRender();});});
      c.querySelectorAll('.week-evt').forEach(function(evt){evt.addEventListener('click',function(e){e.stopPropagation();agOpenDetail(evt.dataset.id);});});
      c.querySelectorAll('.week-slots').forEach(function(slot){slot.addEventListener('click',function(e){if(e.target.closest('.week-evt'))return;var rect=slot.getBoundingClientRect();var y=e.clientY-rect.top;var hour=Math.floor(y/60)+7;var mins=Math.floor((y%60)/15)*15;agOpenCreate(slot.dataset.date,String(hour).padStart(2,'0')+':'+String(mins).padStart(2,'0'));});});
    }

    function agWeekEvt(a){ if(!a.ora)return''; var parts=a.ora.split(':');var top=(parseInt(parts[0],10)-7)*60+parseInt(parts[1],10); if(top<0)return''; var nome=agName(a); var desc=a.descrizione?'<div class="week-evt-desc">'+a.descrizione.substring(0,25)+'</div>':''; return '<div class="week-evt tipo-'+a.tipo+'" data-id="'+a.id+'" style="top:'+top+'px;min-height:55px"><div class="week-evt-time">'+a.ora.substring(0,5)+'</div><div class="week-evt-name">'+nome+'</div>'+desc+'</div>'; }

    function agRenderDay(c){ var ds=agFmt(agendaDate);var isToday=ds===agFmt(new Date());var hours=agHours();var dayAppts=agendaAppointments.filter(function(a){return a.data===ds;}).sort(function(a,b){return(a.ora||'').localeCompare(b.ora||'');}); var h='<div class="dayv-wrap"><div class="dayv-header">'+AG_DAYS[agendaDate.getDay()]+' '+agendaDate.getDate()+' '+AG_MONTHS[agendaDate.getMonth()]+' '+agendaDate.getFullYear(); if(dayAppts.length>0)h+=' &mdash; <span style="color:var(--primary);font-weight:700">'+dayAppts.length+' appuntament'+(dayAppts.length===1?'o':'i')+'</span>'; h+='</div><div class="dayv-body"><div class="dayv-times">'; hours.forEach(function(hr){h+='<div class="dayv-time-label">'+hr+'</div>';}); h+='</div><div class="dayv-content" data-date="'+ds+'">'; hours.forEach(function(){h+='<div class="dayv-hour-row"></div>';}); if(isToday)h+=agNowLine(); dayAppts.forEach(function(a){h+=agDayEvt(a);}); h+='</div></div></div>'; c.innerHTML=h;
      c.querySelectorAll('.dayv-evt').forEach(function(evt){evt.addEventListener('click',function(e){e.stopPropagation();agOpenDetail(evt.dataset.id);});});
      var content=c.querySelector('.dayv-content'); if(content){content.addEventListener('click',function(e){if(e.target.closest('.dayv-evt'))return;var rect=content.getBoundingClientRect();var y=e.clientY-rect.top;var hour=Math.floor(y/60)+7;var mins=Math.floor((y%60)/15)*15;agOpenCreate(content.dataset.date,String(hour).padStart(2,'0')+':'+String(mins).padStart(2,'0'));});}
    }

    function agDayEvt(a){ if(!a.ora)return''; var parts=a.ora.split(':');var top=(parseInt(parts[0],10)-7)*60+parseInt(parts[1],10); if(top<0)return''; var nome=agName(a);var tipoLabel=a.tipo==='richiamo'?'Richiamo':'Appuntamento'; return '<div class="dayv-evt tipo-'+a.tipo+'" data-id="'+a.id+'" style="top:'+top+'px;min-height:58px"><div class="dayv-evt-time">'+a.ora.substring(0,5)+' &middot; '+tipoLabel+'</div><div class="dayv-evt-name">'+nome+'</div><div class="dayv-evt-desc">'+(a.descrizione?a.descrizione.substring(0,70):'')+'</div></div>'; }

    function agNowLine(){ var now=new Date();var top=(now.getHours()-7)*60+now.getMinutes(); if(top<0)return''; return '<div class="now-line" style="top:'+top+'px"></div>'; }

    function agOpenCreate(dateStr,ora){ document.getElementById('agEditId').value=''; document.getElementById('agModalTitle').textContent='Nuovo Appuntamento'; document.getElementById('agData').value=dateStr||agFmt(agendaDate); document.getElementById('agOra').value=ora||'09:00'; document.getElementById('agTipo').value='nuovo'; document.getElementById('agLeadSearch').value=''; document.getElementById('agLeadId').value=''; document.getElementById('agLeadNome').value=''; document.getElementById('agLeadCognome').value=''; document.getElementById('agDescrizione').value=''; document.getElementById('agModalCreate').classList.add('open'); }

    function agOpenDetail(id){ var a=agendaAppointments.find(function(x){return x.id===id;}); if(!a)return; var dateObj=new Date(a.data+'T00:00:00');var dateF=dateObj.getDate()+' '+AG_MONTHS[dateObj.getMonth()]+' '+dateObj.getFullYear();var nome=agName(a);
      var body='<div class="ag-detail-row"><div class="ag-detail-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div><div><div class="ag-detail-label">Data e ora</div><div class="ag-detail-value">'+dateF+' alle '+(a.ora||'--:--')+'</div></div></div>';
      body+='<div class="ag-detail-row"><div class="ag-detail-icon '+(a.tipo==='richiamo'?'orange':'blue')+'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div><div><div class="ag-detail-label">Tipo</div><div class="ag-detail-value"><span class="ag-tipo-badge '+a.tipo+'">'+(a.tipo==='richiamo'?'Richiamo':'Nuovo Appuntamento')+'</span></div></div></div>';
      body+='<div class="ag-detail-row"><div class="ag-detail-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><div><div class="ag-detail-label">Lead</div><div class="ag-detail-value">'+(a.leadId?'<span class="ag-detail-link" data-leadid="'+a.leadId+'">'+nome+'</span>':nome)+'</div></div></div>';
      if(a.descrizione) body+='<div class="ag-detail-row"><div class="ag-detail-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg></div><div><div class="ag-detail-label">Descrizione</div><div class="ag-detail-value">'+a.descrizione+'</div></div></div>';
      if(a.tipo==='richiamo'&&a.leadId) body+='<div style="margin-top:10px;padding:10px;background:#fef3c7;border-radius:8px;text-align:center"><button class="btn btn-primary" style="background:#f59e0b;width:auto;" data-gotolead="'+a.leadId+'">Vedi Scheda Lead</button></div>';
      document.getElementById('agDetailBody').innerHTML=body;
      document.getElementById('agDetailFt').innerHTML='<button class="btn btn-secondary" onclick="document.getElementById(\'agModalDetail\').classList.remove(\'open\')">Chiudi</button><button class="btn btn-primary" style="width:auto;" data-editid="'+a.id+'">Modifica</button><button class="btn btn-red" style="width:auto;" data-deleteid="'+a.id+'">Elimina</button>';
      var detailEl=document.getElementById('agDetailBody');var footerEl=document.getElementById('agDetailFt');
      detailEl.querySelectorAll('.ag-detail-link').forEach(function(link){link.addEventListener('click',function(){document.getElementById('agModalDetail').classList.remove('open');openLeadDetail(link.dataset.leadid);});});
      detailEl.querySelectorAll('[data-gotolead]').forEach(function(btn){btn.addEventListener('click',function(){document.getElementById('agModalDetail').classList.remove('open');openLeadDetail(btn.dataset.gotolead);});});
      footerEl.querySelector('[data-editid]').addEventListener('click',function(){agEditAppt(this.dataset.editid);});
      footerEl.querySelector('[data-deleteid]').addEventListener('click',function(){agDeleteAppt(this.dataset.deleteid);});
      document.getElementById('agModalDetail').classList.add('open');
    }

    function agEditAppt(id){ var a=agendaAppointments.find(function(x){return x.id===id;}); if(!a)return; document.getElementById('agModalDetail').classList.remove('open'); setTimeout(function(){ document.getElementById('agEditId').value=id; document.getElementById('agModalTitle').textContent='Modifica Appuntamento'; document.getElementById('agData').value=a.data; document.getElementById('agOra').value=a.ora; document.getElementById('agTipo').value=a.tipo; document.getElementById('agLeadSearch').value=((a.leadNome||'')+' '+(a.leadCognome||'')).trim(); document.getElementById('agLeadId').value=a.leadId||''; document.getElementById('agLeadNome').value=a.leadNome||''; document.getElementById('agLeadCognome').value=a.leadCognome||''; document.getElementById('agDescrizione').value=a.descrizione||''; document.getElementById('agModalCreate').classList.add('open'); },200); }

    async function agDeleteAppt(id){ if(!confirm('Eliminare questo appuntamento?'))return; try{await deleteDoc(doc(db,'appuntamenti',id));showToast('Appuntamento eliminato','success');document.getElementById('agModalDetail').classList.remove('open');}catch(e){showToast('Errore eliminazione','error');} }

    async function agSaveAppt(){ var data=document.getElementById('agData').value;var ora=document.getElementById('agOra').value;var tipo=document.getElementById('agTipo').value;var leadId=document.getElementById('agLeadId').value;var leadNome=document.getElementById('agLeadNome').value;var leadCognome=document.getElementById('agLeadCognome').value;var descrizione=document.getElementById('agDescrizione').value;var editId=document.getElementById('agEditId').value; if(!data||!ora){showToast('Inserisci data e ora','error');return;} var obj={data:data,ora:ora,tipo:tipo,leadId:leadId||'',leadNome:leadNome||'',leadCognome:leadCognome||'',descrizione:descrizione||'',completato:false}; try{if(editId){await updateDoc(doc(db,'appuntamenti',editId),obj);showToast('Appuntamento aggiornato!','success');}else{await addDoc(collection(db,'appuntamenti'),obj);showToast('Appuntamento creato!','success');}document.getElementById('agModalCreate').classList.remove('open');}catch(e){console.error(e);showToast('Errore nel salvataggio','error');} }

    function agName(a){return(a.leadNome||a.leadCognome)?((a.leadNome||'')+' '+(a.leadCognome||'')).trim():'Senza lead';}
    function agFmt(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
    function agWeekStart(d){var date=new Date(d);var day=date.getDay();var diff=day===0?-6:1-day;date.setDate(date.getDate()+diff);date.setHours(0,0,0,0);return date;}
    function agHours(){var h=[];for(var i=7;i<=21;i++)h.push(String(i).padStart(2,'0')+':00');return h;}

  </script>
</body>
</html>
