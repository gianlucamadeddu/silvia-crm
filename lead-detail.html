<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Silvia CRM — Scheda Lead</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --primary: #1e40af; --primary-dark: #1e3a8a; --primary-light: #dbeafe;
  --green: #22c55e; --green-light: #dcfce7; --orange: #f59e0b; --orange-light: #fef9c3;
  --red: #ef4444; --red-light: #fee2e2; --pink-light: #fce7f3; --border: #e2e8f0;
  --bg: #f8fafc; --white: #ffffff; --text: #1e293b; --text-secondary: #64748b;
  --radius: 8px; --radius-lg: 12px;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
  --font: 'Inter', system-ui, -apple-system, sans-serif;
}
body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.5; -webkit-font-smoothing: antialiased; min-height: 100vh; display: flex; }
button { cursor: pointer; font-family: inherit; }
input, select, textarea { font-family: inherit; }

/* SIDEBAR */
.sidebar { width: 240px; background: var(--white); border-right: 1.5px solid var(--border); display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 100; }
.sidebar-header { padding: 24px 20px 20px; border-bottom: 1.5px solid var(--border); }
.sidebar-brand { font-size: 24px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
.sidebar-tagline { font-size: 12px; color: var(--text-secondary); font-weight: 500; margin-top: 1px; letter-spacing: 1px; text-transform: uppercase; }
.sidebar-nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 6px; }
.sidebar-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; font-size: 14px; font-weight: 500; color: var(--text-secondary); text-decoration: none; border: 1px solid var(--border); background: var(--white); box-shadow: 0 1px 3px rgba(0,0,0,0.06); transition: all .15s; }
.sidebar-item:hover { background: var(--bg); color: var(--text); transform: translateY(-1px); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
.sidebar-item.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 8px rgba(30,64,175,0.3); }
.sidebar-item svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; flex-shrink: 0; }

/* MAIN */
.main { margin-left: 240px; flex: 1; min-height: 100vh; }

/* BUTTONS */
.btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 9px 18px; border-radius: var(--radius); font-size: 13px; font-weight: 600; border: none; transition: all .15s; white-space: nowrap; font-family: var(--font); }
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-green { background: var(--green); color: #fff; }
.btn-green:hover { background: #16a34a; }
.btn-red { background: var(--red); color: #fff; }
.btn-red:hover { background: #dc2626; }
.btn-whatsapp { background: #25d366; color: #fff; }
.btn-whatsapp:hover { background: #1ebe5d; }
.btn-secondary { background: var(--white); color: var(--text); border: 1.5px solid var(--border); }
.btn-secondary:hover { background: var(--bg); }
.btn-sm { padding: 6px 12px; font-size: 12px; }
.btn svg { width: 16px; height: 16px; }

/* BADGE */
.badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }

/* DETAIL LAYOUT */
.detail-page { display: flex; gap: 0; min-height: 100vh; }
.detail-main { flex: 1; padding: 28px 32px; overflow-y: auto; }
.detail-sidebar { width: 280px; background: var(--white); border-left: 1.5px solid var(--border); padding: 24px 20px; position: sticky; top: 0; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }

/* HEADER */
.detail-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
.detail-back { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: var(--radius); font-size: 13px; font-weight: 500; color: var(--text-secondary); background: var(--white); border: 1.5px solid var(--border); text-decoration: none; transition: all .15s; }
.detail-back:hover { background: var(--bg); color: var(--text); }
.detail-back svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2; }
.detail-name { font-size: 24px; font-weight: 700; color: var(--text); }
.detail-created { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

/* TABS */
.tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 24px; overflow-x: auto; }
.tab-btn { padding: 12px 20px; font-size: 13px; font-weight: 600; color: var(--text-secondary); background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all .15s; white-space: nowrap; font-family: var(--font); }
.tab-btn:hover { color: var(--text); }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* FORMS */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-group.full { grid-column: 1 / -1; }
.form-group label { font-size: 12px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.form-group input, .form-group select, .form-group textarea { padding: 9px 12px; border-radius: var(--radius); border: 1.5px solid var(--border); font-size: 13px; color: var(--text); outline: none; transition: border .15s; background: var(--white); width: 100%; }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary); }
.form-group textarea { resize: vertical; min-height: 70px; }
.form-group input:read-only { background: var(--bg); color: var(--text-secondary); cursor: not-allowed; }
.required::after { content: " *"; color: var(--red); }

/* SECTIONS */
.section { margin-bottom: 28px; }
.section-title { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 14px; padding-bottom: 8px; border-bottom: 1.5px solid #f1f5f9; }

/* CHECKBOX GROUP */
.checkbox-group { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; padding: 4px 0; }
.checkbox-item { display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; color: var(--text); cursor: pointer; }
.checkbox-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); cursor: pointer; }

/* RATE TABLE */
.rate-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
.rate-table th { background: var(--bg); padding: 8px 12px; text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); font-weight: 600; }
.rate-table td { padding: 8px 12px; border-top: 1px solid #f1f5f9; vertical-align: middle; }
.rate-table input, .rate-table select { padding: 7px 10px; border: 1.5px solid var(--border); border-radius: var(--radius); font-size: 13px; color: var(--text); outline: none; font-family: var(--font); width: 100%; }
.rate-table input:focus { border-color: var(--primary); }
.rate-total { display: flex; justify-content: flex-end; align-items: center; gap: 12px; padding: 14px 0; margin-top: 8px; border-top: 2px solid var(--border); }
.rate-total-label { font-size: 14px; font-weight: 600; color: var(--text-secondary); }
.rate-total-value { font-size: 22px; font-weight: 700; color: var(--text); }

/* TIMELINE */
.timeline { display: flex; flex-direction: column; gap: 10px; }
.timeline-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px 14px; border-left: 3px solid; border-radius: 0 var(--radius) var(--radius) 0; background: var(--bg); transition: background .15s; }
.timeline-item:hover { background: #f1f5f9; }
.ti-content { flex: 1; }
.ti-value { font-size: 13px; font-weight: 600; color: var(--text); }
.ti-label { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
.ti-date { font-size: 11px; color: #94a3b8; white-space: nowrap; margin-top: 2px; }
.timeline-empty { font-size: 13px; color: var(--text-secondary); padding: 20px 0; text-align: center; }

/* NOTE */
.note-card { background: var(--bg); border-radius: var(--radius); padding: 14px 16px; margin-bottom: 10px; position: relative; border: 1px solid #f1f5f9; }
.note-card:hover { border-color: var(--border); }
.note-text { font-size: 13px; color: var(--text); white-space: pre-wrap; line-height: 1.6; }
.note-date { font-size: 11px; color: #94a3b8; margin-top: 6px; }
.note-delete { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #cbd5e1; padding: 2px; border-radius: 4px; transition: all .15s; }
.note-delete:hover { color: var(--red); background: var(--red-light); }
.note-delete svg { width: 14px; height: 14px; }
.note-input-row { display: flex; gap: 10px; align-items: flex-start; }
.note-input-row textarea { flex: 1; padding: 10px 14px; border: 1.5px solid var(--border); border-radius: var(--radius); font-size: 13px; color: var(--text); outline: none; resize: vertical; min-height: 60px; font-family: var(--font); }
.note-input-row textarea:focus { border-color: var(--primary); }

/* ACTION PANEL */
.action-group { margin-bottom: 20px; }
.action-group-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 10px; }
.action-btn { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 14px; border-radius: var(--radius); font-size: 13px; font-weight: 500; border: 1.5px solid var(--border); background: var(--white); color: var(--text); transition: all .15s; font-family: var(--font); }
.action-btn:hover { background: var(--bg); transform: translateY(-1px); box-shadow: var(--shadow); }
.action-btn svg { width: 18px; height: 18px; flex-shrink: 0; }
.action-btn.whatsapp { color: #25d366; border-color: #25d36640; }
.action-btn.whatsapp:hover { background: #25d36610; }
.action-btn.danger { color: var(--red); border-color: #ef444440; }
.action-btn.danger:hover { background: var(--red-light); }
.action-stato-select { width: 100%; padding: 10px 14px; border-radius: var(--radius); border: 1.5px solid var(--border); font-size: 13px; font-weight: 600; color: var(--text); background: var(--white); outline: none; font-family: var(--font); }
.action-stato-select:focus { border-color: var(--primary); }

/* FILE UPLOAD */
.file-upload-area { border: 2px dashed #cbd5e1; border-radius: var(--radius); padding: 16px; text-align: center; cursor: pointer; transition: all .2s; position: relative; }
.file-upload-area:hover { border-color: var(--primary); background: #eff6ff; }
.file-upload-area input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
.file-upload-area p { font-size: 12px; color: var(--text-secondary); }
.file-upload-area svg { width: 24px; height: 24px; color: #94a3b8; margin-bottom: 4px; }
.file-link { display: inline-flex; align-items: center; gap: 6px; font-size: 13px; color: var(--primary); font-weight: 500; text-decoration: none; }
.file-link:hover { text-decoration: underline; }

/* MODALS */
.modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 500; align-items: center; justify-content: center; }
.modal-overlay.open { display: flex; }
.modal { background: var(--white); border-radius: 16px; padding: 28px; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
.modal h2 { font-size: 18px; font-weight: 700; margin-bottom: 18px; color: var(--text); }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.modal-actions .btn { width: auto; }

/* TOAST */
.toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: 10px; color: #fff; font-size: 13px; font-weight: 600; z-index: 9999; opacity: 0; transform: translateY(10px); transition: all .25s; pointer-events: none; }
.toast.show { opacity: 1; transform: translateY(0); }
.toast.success { background: var(--green); }
.toast.error { background: var(--red); }
.toast.info { background: var(--primary); }

/* SPINNER */
.spinner { width: 22px; height: 22px; border: 2.5px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-center { display: flex; justify-content: center; align-items: center; padding: 60px; }

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

/* RESPONSIVE */
@media (max-width: 1100px) {
  .detail-page { flex-direction: column; }
  .detail-sidebar { width: 100%; position: static; height: auto; border-left: none; border-top: 1.5px solid var(--border); flex-direction: row; flex-wrap: wrap; padding: 16px 32px; }
  .action-group { flex: 1; min-width: 200px; }
}
@media (max-width: 768px) {
  .sidebar { width: 60px; }
  .sidebar-brand, .sidebar-tagline, .sidebar-item span { display: none; }
  .sidebar-item { justify-content: center; padding: 10px; }
  .main { margin-left: 60px; }
  .detail-main { padding: 16px; }
  .form-grid { grid-template-columns: 1fr; }
  .tab-btn { padding: 10px 14px; font-size: 12px; }
  .detail-sidebar { padding: 16px; }
  .detail-header { flex-direction: column; align-items: flex-start; gap: 10px; }
  .note-input-row { flex-direction: column; }
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-brand">SILVIA</div>
    <div class="sidebar-tagline">Vendita</div>
  </div>
  <div class="sidebar-nav">
    <a href="index.html" class="sidebar-item"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg><span>Dashboard</span></a>
    <a href="lead.html" class="sidebar-item active"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Lead</span></a>
    <a href="agenda.html" class="sidebar-item"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>Agenda</span></a>
    <a href="template.html" class="sidebar-item"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><span>Template</span></a>
    <a href="impostazioni.html" class="sidebar-item"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span>Impostazioni</span></a>
    <a href="report.html" class="sidebar-item"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span>Report</span></a>
  </div>
</nav>

<!-- MAIN -->
<div class="main">
  <div class="loading-center" id="loadingState"><div class="spinner"></div></div>
  <div class="detail-page" id="detailPage" style="display:none;">
    <div class="detail-main">
      <!-- HEADER -->
      <div class="detail-header">
        <a href="lead.html" class="detail-back" id="btnBack"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg> Torna ai Lead</a>
        <div style="flex:1;">
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
            <h1 class="detail-name" id="detailName">Nuovo Lead</h1>
            <span class="badge" id="detailBadge" style="display:none;"></span>
          </div>
          <div class="detail-created" id="detailCreated"></div>
        </div>
      </div>

      <!-- TABS NAV -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="anagrafica">Dati Anagrafici</button>
        <button class="tab-btn" data-tab="studente">Dati Studente</button>
        <button class="tab-btn" data-tab="pagamenti">Pagamenti</button>
        <button class="tab-btn" data-tab="storico">Storico Stati</button>
        <button class="tab-btn" data-tab="note">Note</button>
      </div>

      <!-- TAB 1: ANAGRAFICA -->
      <div class="tab-content active" id="tab-anagrafica">
        <div class="section">
          <div class="section-title">Informazioni Personali</div>
          <div class="form-grid">
            <div class="form-group"><label class="required">Nome</label><input type="text" id="fNome"></div>
            <div class="form-group"><label class="required">Cognome</label><input type="text" id="fCognome"></div>
            <div class="form-group"><label class="required">Telefono</label><input type="tel" id="fTelefono"></div>
            <div class="form-group"><label>Email</label><input type="email" id="fEmail"></div>
            <div class="form-group"><label>Provincia</label><input type="text" id="fProvincia"></div>
            <div class="form-group"><label>Fonte</label><select id="fFonte"><option value="">Seleziona...</option></select></div>
            <div class="form-group"><label>Data creazione</label><input type="text" id="fDataCreazione" readonly></div>
            <div class="form-group"><label>È minore?</label><select id="fIsMinore"><option value="false">No</option><option value="true">Sì</option></select></div>
          </div>
        </div>
        <div class="section" id="genitoreSection" style="display:none;">
          <div class="section-title">Dati Genitore / Tutore</div>
          <div class="form-grid">
            <div class="form-group"><label>Nome genitore</label><input type="text" id="fGenNome"></div>
            <div class="form-group"><label>Cognome genitore</label><input type="text" id="fGenCognome"></div>
            <div class="form-group"><label>Telefono genitore</label><input type="tel" id="fGenTelefono"></div>
            <div class="form-group"><label>Email genitore</label><input type="email" id="fGenEmail"></div>
          </div>
        </div>
        <div style="display:flex;justify-content:flex-end;margin-top:20px;"><button class="btn btn-green" id="btnSaveAnagrafica"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Salva modifiche</button></div>
      </div>

      <!-- TAB 2: STUDENTE -->
      <div class="tab-content" id="tab-studente">
        <div class="section">
          <div class="section-title">Dati Personali Studente</div>
          <div class="form-grid">
            <div class="form-group"><label>Data di nascita</label><input type="date" id="fDataNascita"></div>
            <div class="form-group"><label>Codice Fiscale</label><input type="text" id="fCodiceFiscale" maxlength="16" style="text-transform:uppercase;"></div>
            <div class="form-group full"><label>Residenza</label><input type="text" id="fResidenza"></div>
            <div class="form-group"><label>Cellulare studente</label><input type="tel" id="fCellStudente"></div>
            <div class="form-group"><label>Email studente</label><input type="email" id="fEmailStudente"></div>
          </div>
        </div>
        <div class="section">
          <div class="section-title">Percorso Scolastico</div>
          <div class="form-grid">
            <div class="form-group"><label>Scuola di provenienza</label><input type="text" id="fScuolaProvenienza"></div>
            <div class="form-group"><label>Data ritiro da scuola</label><input type="date" id="fDataRitiro"></div>
            <div class="form-group"><label>Macro Area</label><select id="fMacroArea"><option value="">Seleziona...</option></select></div>
            <div class="form-group"><label>Corso di studi</label><select id="fCorsoStudi"><option value="">Seleziona...</option></select></div>
            <div class="form-group"><label>Servizio</label><select id="fServizio"><option value="">Seleziona...</option><option value="Frequenza in sede">Frequenza in sede</option><option value="Frequenza online">Frequenza online</option><option value="Senza Frequenza">Senza Frequenza</option></select></div>
            <div class="form-group"><label>Classi di recupero</label><div class="checkbox-group"><label class="checkbox-item"><input type="checkbox" value="I" class="classeCheck"> I</label><label class="checkbox-item"><input type="checkbox" value="II" class="classeCheck"> II</label><label class="checkbox-item"><input type="checkbox" value="III" class="classeCheck"> III</label><label class="checkbox-item"><input type="checkbox" value="IV" class="classeCheck"> IV</label><label class="checkbox-item"><input type="checkbox" value="V" class="classeCheck"> V</label></div></div>
            <div class="form-group"><label>Inserimento in classe</label><select id="fInserimentoClasse"><option value="">Seleziona...</option></select></div>
            <div class="form-group"><label>Partenze effettuate</label><input type="text" id="fPartenze"></div>
            <div class="form-group"><label>Scuola di assegnazione</label><select id="fScuolaAssegnazione"><option value="">Seleziona...</option></select></div>
            <div class="form-group"><label>Calendario scolastico</label><div id="calendarioContainer"><div class="file-upload-area"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg><p>Clicca o trascina per caricare</p><input type="file" id="fCalendarioFile" accept=".pdf,.doc,.docx,.jpg,.png"></div><div id="calendarioLink" style="display:none;margin-top:8px;"></div></div></div>
          </div>
        </div>
        <div style="display:flex;justify-content:flex-end;margin-top:20px;"><button class="btn btn-green" id="btnSaveStudente"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Salva modifiche</button></div>
      </div>

      <!-- TAB 3: PAGAMENTI -->
      <div class="tab-content" id="tab-pagamenti">
        <div class="section">
          <div class="section-title">Modalità di Pagamento</div>
          <div class="form-group" style="max-width:400px;"><label>Modalità</label><select id="fModalitaPagamento"><option value="">Seleziona...</option></select></div>
        </div>
        <div class="section">
          <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;">Rate <button class="btn btn-sm btn-secondary" id="btnAddRata"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Aggiungi rata</button></div>
          <table class="rate-table"><thead><tr><th style="width:50px;">#</th><th>Importo (€)</th><th>Data Scadenza</th><th style="width:100px;">Pagato</th><th style="width:50px;"></th></tr></thead><tbody id="rateBody"></tbody></table>
          <div class="rate-total"><span class="rate-total-label">Totale:</span><span class="rate-total-value" id="rateTotale">€ 0,00</span></div>
        </div>
        <div style="display:flex;justify-content:flex-end;margin-top:20px;"><button class="btn btn-green" id="btnSavePagamenti"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Salva modifiche</button></div>
      </div>

      <!-- TAB 4: STORICO -->
      <div class="tab-content" id="tab-storico">
        <div class="timeline" id="storicoTimeline"><div class="timeline-empty">Caricamento...</div></div>
      </div>

      <!-- TAB 5: NOTE -->
      <div class="tab-content" id="tab-note">
        <div class="note-input-row" style="margin-bottom:20px;">
          <textarea id="fNuovaNota" placeholder="Scrivi una nota..."></textarea>
          <button class="btn btn-primary" id="btnAddNota" style="align-self:flex-end;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Aggiungi</button>
        </div>
        <div id="noteList"></div>
      </div>
    </div>

    <!-- ACTION PANEL (RIGHT) -->
    <div class="detail-sidebar" id="actionPanel">
      <div class="action-group">
        <div class="action-group-title">Stato Lead</div>
        <select class="action-stato-select" id="actionStato"></select>
      </div>
      <div class="action-group">
        <div class="action-group-title">Comunicazioni</div>
        <button class="action-btn whatsapp" id="actionWA"><svg viewBox="0 0 24 24" fill="#25d366" stroke="none"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.625.846 5.059 2.284 7.034L.789 23.492a.5.5 0 0 0 .613.613l4.458-1.495A11.952 11.952 0 0 0 12 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 22c-2.352 0-4.55-.752-6.338-2.034l-.442-.332-3.263 1.093 1.093-3.263-.332-.442A9.955 9.955 0 0 1 2 12C2 6.486 6.486 2 12 2s10 4.486 10 10-4.486 10-10 10z"/></svg> WhatsApp</button>
        <button class="action-btn" id="actionEmail" style="margin-top:6px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> Email</button>
        <button class="action-btn" id="actionChiama" style="margin-top:6px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg> Chiama</button>
      </div>
      <div class="action-group">
        <div class="action-group-title">Agenda</div>
        <button class="action-btn" id="actionAppuntamento"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Nuovo Appuntamento</button>
      </div>
      <div class="action-group">
        <div class="action-group-title">Template</div>
        <button class="action-btn" id="actionTemplate"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg> Usa Template</button>
      </div>
      <div class="action-group" style="margin-top:auto;">
        <button class="action-btn danger" id="actionDelete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Elimina Lead</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: APPUNTAMENTO -->
<div class="modal-overlay" id="appointmentModal">
  <div class="modal">
    <h2>Nuovo Appuntamento</h2>
    <div class="form-grid">
      <div class="form-group"><label class="required">Data</label><input type="date" id="appData"></div>
      <div class="form-group"><label class="required">Ora</label><input type="time" id="appOra"></div>
      <div class="form-group"><label>Tipo</label><select id="appTipo"><option value="nuovo">Nuovo</option><option value="richiamo">Richiamo</option></select></div>
      <div class="form-group full"><label>Descrizione</label><textarea id="appDescrizione" rows="2"></textarea></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('appointmentModal')">Annulla</button>
      <button class="btn btn-primary" id="btnSaveAppointment" style="width:auto;">Salva Appuntamento</button>
    </div>
  </div>
</div>

<!-- MODAL: TEMPLATE -->
<div class="modal-overlay" id="templateModal">
  <div class="modal" style="max-width:700px;">
    <h2>Seleziona Template</h2>
    <div id="templateList" style="max-height:300px;overflow-y:auto;margin-bottom:16px;"></div>
    <div id="templatePreview" style="display:none;">
      <div style="font-size:12px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;">Anteprima</div>
      <div id="templatePreviewText" style="background:var(--bg);border-radius:var(--radius);padding:16px;font-size:13px;white-space:pre-wrap;border:1px solid var(--border);margin-bottom:16px;max-height:200px;overflow-y:auto;"></div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-whatsapp btn-sm" id="btnTemplateSendWA">Invia via WhatsApp</button>
        <button class="btn btn-secondary btn-sm" id="btnTemplateSendEmail">Invia via Email</button>
      </div>
    </div>
    <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal('templateModal')">Chiudi</button></div>
  </div>
</div>

<!-- MODAL: DELETE -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal">
    <h2>Conferma eliminazione</h2>
    <p style="font-size:14px;color:var(--text-secondary);margin-bottom:6px;">Sei sicuro di voler eliminare questo lead? Questa azione è irreversibile.</p>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Annulla</button>
      <button class="btn btn-red" id="btnConfirmDelete">Elimina</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAuYeUI9sNaoXpQCkN_XrXOF34VGWN7oTI",
  authDomain: "silvia-crm-ce19b.firebaseapp.com",
  projectId: "silvia-crm-ce19b",
  storageBucket: "silvia-crm-ce19b.firebasestorage.app",
  messagingSenderId: "1041049614523",
  appId: "1:1041049614523:web:250bd3bc60ffbcfe32119e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

let currentLeadId = null;
let currentLead = null;
let allStati = [], allFonti = [], allCorsi = [], allClassi = [];
let allMacroAree = [], allScuoleAssegnazione = [], allModalitaPagamento = [], allTemplates = [];
let rateCount = 0, currentTemplateText = '';

// === INIT ===
document.addEventListener('DOMContentLoaded', async () => {
  const params = new URLSearchParams(window.location.search);
  currentLeadId = params.get('id');

  await Promise.all([
    loadCollection('stati', 'allStati'), loadCollection('fonti', 'allFonti'),
    loadCollection('corsiStudi', 'allCorsi'), loadCollection('classi', 'allClassi'),
    loadCollection('macroAree', 'allMacroAree'), loadCollection('scuoleAssegnazione', 'allScuoleAssegnazione'),
    loadCollection('modalitaPagamento', 'allModalitaPagamento'), loadTemplatesData()
  ]);

  populateDropdowns();

  if (currentLeadId && currentLeadId !== 'new') {
    await loadLead(currentLeadId);
  } else {
    currentLeadId = null;
    document.getElementById('detailName').textContent = 'Nuovo Lead';
    document.getElementById('fDataCreazione').value = new Date().toLocaleDateString('it-IT');
    document.getElementById('actionPanel').style.display = 'none';
  }

  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('detailPage').style.display = 'flex';
  setupTabs();
  setupEvents();
});

// === LOAD COLLECTIONS ===
const collections = { allStati: [], allFonti: [], allCorsi: [], allClassi: [], allMacroAree: [], allScuoleAssegnazione: [], allModalitaPagamento: [] };

async function loadCollection(name, target) {
  try {
    const snap = await db.collection('impostazioni').doc(name).collection('items').orderBy('posizione').get();
    const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    if (target === 'allStati') allStati = arr;
    else if (target === 'allFonti') allFonti = arr;
    else if (target === 'allCorsi') allCorsi = arr;
    else if (target === 'allClassi') allClassi = arr;
    else if (target === 'allMacroAree') allMacroAree = arr;
    else if (target === 'allScuoleAssegnazione') allScuoleAssegnazione = arr;
    else if (target === 'allModalitaPagamento') allModalitaPagamento = arr;
  } catch (e) {
    console.warn('Errore caricamento ' + name, e);
    if (target === 'allStati') allStati = [{ id: 'default', nome: 'Nuovo', colore: '#22c55e', posizione: 0 }];
  }
}

async function loadTemplatesData() {
  try { const snap = await db.collection('templates').get(); allTemplates = snap.docs.map(d => ({ id: d.id, ...d.data() })); }
  catch (e) { allTemplates = []; }
}

function populateDropdowns() {
  fillSelect('actionStato', allStati);
  fillSelect('fFonte', allFonti, true);
  fillSelect('fCorsoStudi', allCorsi, true);
  fillSelect('fInserimentoClasse', allClassi, true);
  fillSelect('fMacroArea', allMacroAree, true);
  fillSelect('fScuolaAssegnazione', allScuoleAssegnazione, true);
  fillSelect('fModalitaPagamento', allModalitaPagamento, true);
}

function fillSelect(id, items, addEmpty = false) {
  const sel = document.getElementById(id);
  if (!sel) return;
  sel.innerHTML = addEmpty ? '<option value="">Seleziona...</option>' : '';
  items.forEach(i => { sel.innerHTML += '<option value="' + i.nome + '">' + i.nome + '</option>'; });
}

// === LOAD LEAD ===
async function loadLead(id) {
  try {
    const docSnap = await db.collection('leads').doc(id).get();
    if (!docSnap.exists) { showToast('Lead non trovato', 'error'); setTimeout(() => window.location.href = 'lead.html', 1500); return; }
    currentLead = { id: docSnap.id, ...docSnap.data() };
    fillForm(currentLead);
    loadStorico(id);
    loadNote(id);
  } catch (err) { console.error(err); showToast('Errore nel caricamento', 'error'); }
}

function fillForm(lead) {
  document.getElementById('detailName').textContent = ((lead.nome || '') + ' ' + (lead.cognome || '')).trim() || 'Senza nome';
  const statoObj = allStati.find(s => s.nome === lead.stato);
  if (statoObj) {
    const badge = document.getElementById('detailBadge');
    badge.textContent = statoObj.nome;
    badge.style.background = statoObj.colore + '20';
    badge.style.color = statoObj.colore;
    badge.style.display = 'inline-block';
  }
  const created = lead.dataCreazione && lead.dataCreazione.toDate ? lead.dataCreazione.toDate() : null;
  if (created) {
    document.getElementById('detailCreated').textContent = 'Creato il ' + created.toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' });
    document.getElementById('fDataCreazione').value = created.toLocaleDateString('it-IT');
  }
  // Anagrafica
  document.getElementById('fNome').value = lead.nome || '';
  document.getElementById('fCognome').value = lead.cognome || '';
  document.getElementById('fTelefono').value = lead.telefono || '';
  document.getElementById('fEmail').value = lead.email || '';
  document.getElementById('fProvincia').value = lead.provincia || '';
  document.getElementById('fFonte').value = lead.fonte || '';
  document.getElementById('fIsMinore').value = lead.isMinore ? 'true' : 'false';
  toggleGenitore();
  if (lead.genitore) {
    document.getElementById('fGenNome').value = lead.genitore.nome || '';
    document.getElementById('fGenCognome').value = lead.genitore.cognome || '';
    document.getElementById('fGenTelefono').value = lead.genitore.telefono || '';
    document.getElementById('fGenEmail').value = lead.genitore.email || '';
  }
  // Studente
  const s = lead.studente || {};
  if (s.dataNascita) document.getElementById('fDataNascita').value = s.dataNascita;
  document.getElementById('fCodiceFiscale').value = s.codiceFiscale || '';
  document.getElementById('fResidenza').value = s.residenza || '';
  document.getElementById('fCellStudente').value = s.cellulare || '';
  document.getElementById('fEmailStudente').value = s.email || '';
  document.getElementById('fScuolaProvenienza').value = s.scuolaProvenienza || '';
  if (s.dataRitiroScuola) document.getElementById('fDataRitiro').value = s.dataRitiroScuola;
  document.getElementById('fMacroArea').value = s.macroArea || '';
  document.getElementById('fCorsoStudi').value = s.corsoStudi || '';
  document.getElementById('fServizio').value = s.servizio || '';
  document.getElementById('fInserimentoClasse').value = s.inserimentoClasse || '';
  document.getElementById('fPartenze').value = s.partenzeEffettuate || '';
  document.getElementById('fScuolaAssegnazione').value = s.scuolaAssegnazione || '';
  if (s.classiRecupero && Array.isArray(s.classiRecupero)) {
    document.querySelectorAll('.classeCheck').forEach(cb => { cb.checked = s.classiRecupero.includes(cb.value); });
  }
  if (s.calendarioScolastico) {
    document.getElementById('calendarioLink').innerHTML = '<a href="' + s.calendarioScolastico + '" target="_blank" class="file-link"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Scarica calendario</a>';
    document.getElementById('calendarioLink').style.display = 'block';
  }
  // Pagamenti
  const p = lead.pagamento || {};
  document.getElementById('fModalitaPagamento').value = p.modalita || '';
  rateCount = 0; document.getElementById('rateBody').innerHTML = '';
  if (p.rate && Array.isArray(p.rate)) p.rate.forEach(r => addRataRow(r));
  updateTotale();
  // Stato
  document.getElementById('actionStato').value = lead.stato || 'Nuovo';
}

// === TABS ===
function setupTabs() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
  });
}

// === EVENTS ===
function setupEvents() {
  document.getElementById('fIsMinore').addEventListener('change', toggleGenitore);
  document.getElementById('btnSaveAnagrafica').addEventListener('click', saveAnagrafica);
  document.getElementById('btnSaveStudente').addEventListener('click', saveStudente);
  document.getElementById('btnSavePagamenti').addEventListener('click', savePagamenti);
  document.getElementById('btnAddRata').addEventListener('click', () => addRataRow());
  document.getElementById('btnAddNota').addEventListener('click', addNota);
  document.getElementById('actionStato').addEventListener('change', changeStato);
  document.getElementById('actionWA').addEventListener('click', () => {
    const tel = document.getElementById('fTelefono').value.replace(/\D/g, '');
    if (tel) window.open('https://wa.me/39' + tel, '_blank'); else showToast('Nessun telefono', 'error');
  });
  document.getElementById('actionEmail').addEventListener('click', () => {
    const em = document.getElementById('fEmail').value; if (em) window.open('mailto:' + em); else showToast('Nessuna email', 'error');
  });
  document.getElementById('actionChiama').addEventListener('click', () => {
    const tel = document.getElementById('fTelefono').value; if (tel) window.open('tel:' + tel); else showToast('Nessun telefono', 'error');
  });
  document.getElementById('actionAppuntamento').addEventListener('click', () => openModal('appointmentModal'));
  document.getElementById('btnSaveAppointment').addEventListener('click', saveAppointment);
  document.getElementById('actionTemplate').addEventListener('click', openTemplateModal);
  document.getElementById('actionDelete').addEventListener('click', () => openModal('deleteModal'));
  document.getElementById('btnConfirmDelete').addEventListener('click', deleteLead);
  document.getElementById('fCalendarioFile').addEventListener('change', uploadCalendario);
}

function toggleGenitore() {
  document.getElementById('genitoreSection').style.display = document.getElementById('fIsMinore').value === 'true' ? 'block' : 'none';
}

// === SAVE ANAGRAFICA ===
async function saveAnagrafica() {
  const nome = document.getElementById('fNome').value.trim();
  const cognome = document.getElementById('fCognome').value.trim();
  const telefono = document.getElementById('fTelefono').value.trim();
  if (!nome || !cognome || !telefono) { showToast('Nome, Cognome e Telefono sono obbligatori', 'error'); return; }
  const data = { nome, cognome, telefono, email: document.getElementById('fEmail').value.trim(), provincia: document.getElementById('fProvincia').value.trim(), fonte: document.getElementById('fFonte').value, isMinore: document.getElementById('fIsMinore').value === 'true' };
  if (data.isMinore) {
    data.genitore = { nome: document.getElementById('fGenNome').value.trim(), cognome: document.getElementById('fGenCognome').value.trim(), telefono: document.getElementById('fGenTelefono').value.trim(), email: document.getElementById('fGenEmail').value.trim() };
  } else { data.genitore = null; }
  try {
    if (currentLeadId) {
      await db.collection('leads').doc(currentLeadId).update(data);
      document.getElementById('detailName').textContent = nome + ' ' + cognome;
      showToast('Anagrafica salvata!', 'success');
    } else {
      data.stato = 'Nuovo'; data.dataCreazione = firebase.firestore.FieldValue.serverTimestamp();
      data.studente = {}; data.pagamento = { modalita: '', rate: [] };
      const ref = await db.collection('leads').add(data);
      currentLeadId = ref.id;
      await db.collection('leads').doc(ref.id).collection('storicoStati').add({ statoPrecedente: null, statoNuovo: 'Nuovo', data: firebase.firestore.FieldValue.serverTimestamp(), origine: 'Creazione manuale' });
      window.history.replaceState({}, '', 'lead-detail.html?id=' + ref.id);
      document.getElementById('actionPanel').style.display = '';
      document.getElementById('detailName').textContent = nome + ' ' + cognome;
      document.getElementById('actionStato').value = 'Nuovo';
      const badge = document.getElementById('detailBadge');
      badge.textContent = 'Nuovo'; badge.style.background = '#22c55e20'; badge.style.color = '#22c55e'; badge.style.display = 'inline-block';
      loadStorico(ref.id);
      showToast('Lead creato con successo!', 'success');
    }
  } catch (err) { console.error(err); showToast('Errore nel salvataggio', 'error'); }
}

// === SAVE STUDENTE ===
async function saveStudente() {
  if (!currentLeadId) { showToast('Salva prima l\'anagrafica', 'error'); return; }
  const classiRecupero = []; document.querySelectorAll('.classeCheck:checked').forEach(cb => classiRecupero.push(cb.value));
  const studente = { dataNascita: document.getElementById('fDataNascita').value || '', codiceFiscale: document.getElementById('fCodiceFiscale').value.trim().toUpperCase(), residenza: document.getElementById('fResidenza').value.trim(), cellulare: document.getElementById('fCellStudente').value.trim(), email: document.getElementById('fEmailStudente').value.trim(), scuolaProvenienza: document.getElementById('fScuolaProvenienza').value.trim(), dataRitiroScuola: document.getElementById('fDataRitiro').value || '', macroArea: document.getElementById('fMacroArea').value, corsoStudi: document.getElementById('fCorsoStudi').value, servizio: document.getElementById('fServizio').value, classiRecupero, inserimentoClasse: document.getElementById('fInserimentoClasse').value, partenzeEffettuate: document.getElementById('fPartenze').value.trim(), scuolaAssegnazione: document.getElementById('fScuolaAssegnazione').value };
  if (currentLead && currentLead.studente && currentLead.studente.calendarioScolastico) studente.calendarioScolastico = currentLead.studente.calendarioScolastico;
  try {
    await db.collection('leads').doc(currentLeadId).update({ studente });
    if (currentLead) currentLead.studente = studente;
    showToast('Dati studente salvati!', 'success');
  } catch (err) { console.error(err); showToast('Errore nel salvataggio', 'error'); }
}

// === FILE UPLOAD ===
async function uploadCalendario(e) {
  const file = e.target.files[0];
  if (!file || !currentLeadId) { if (!currentLeadId) showToast('Salva prima l\'anagrafica', 'error'); return; }
  try {
    const fileRef = storage.ref('calendari/' + currentLeadId + '/' + file.name);
    showToast('Caricamento...', 'info');
    await fileRef.put(file);
    const url = await fileRef.getDownloadURL();
    await db.collection('leads').doc(currentLeadId).update({ 'studente.calendarioScolastico': url });
    document.getElementById('calendarioLink').innerHTML = '<a href="' + url + '" target="_blank" class="file-link"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> ' + file.name + '</a>';
    document.getElementById('calendarioLink').style.display = 'block';
    if (currentLead) { if (!currentLead.studente) currentLead.studente = {}; currentLead.studente.calendarioScolastico = url; }
    showToast('File caricato!', 'success');
  } catch (err) { console.error(err); showToast('Errore upload', 'error'); }
}

// === SAVE PAGAMENTI ===
async function savePagamenti() {
  if (!currentLeadId) { showToast('Salva prima l\'anagrafica', 'error'); return; }
  const rate = [];
  document.querySelectorAll('#rateBody tr').forEach(tr => {
    rate.push({ importo: parseFloat(tr.querySelector('.rata-importo').value) || 0, dataScadenza: tr.querySelector('.rata-scadenza').value || '', pagato: tr.querySelector('.rata-pagato').checked });
  });
  const pagamento = { modalita: document.getElementById('fModalitaPagamento').value, rate };
  try {
    await db.collection('leads').doc(currentLeadId).update({ pagamento });
    if (currentLead) currentLead.pagamento = pagamento;
    showToast('Pagamenti salvati!', 'success');
  } catch (err) { console.error(err); showToast('Errore nel salvataggio', 'error'); }
}

// === RATE ===
function addRataRow(data) {
  data = data || {};
  rateCount++;
  const tr = document.createElement('tr');
  tr.innerHTML = '<td style="font-weight:600;color:var(--text-secondary);text-align:center;">' + rateCount + '</td><td><input type="number" class="rata-importo" value="' + (data.importo || '') + '" placeholder="0.00" min="0" step="0.01" oninput="updateTotale()"></td><td><input type="date" class="rata-scadenza" value="' + (data.dataScadenza || '') + '"></td><td style="text-align:center;"><input type="checkbox" class="rata-pagato" ' + (data.pagato ? 'checked' : '') + ' style="width:18px;height:18px;accent-color:var(--green);cursor:pointer;"></td><td style="text-align:center;"><button onclick="removeRata(this)" style="background:none;border:none;color:#cbd5e1;padding:4px;border-radius:4px;cursor:pointer;" title="Rimuovi"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></td>';
  document.getElementById('rateBody').appendChild(tr);
  updateTotale();
}

function removeRata(btn) {
  btn.closest('tr').remove();
  rateCount = 0;
  document.querySelectorAll('#rateBody tr').forEach(tr => { rateCount++; tr.querySelector('td').textContent = rateCount; });
  updateTotale();
}

function updateTotale() {
  let tot = 0;
  document.querySelectorAll('.rata-importo').forEach(inp => { tot += parseFloat(inp.value) || 0; });
  document.getElementById('rateTotale').textContent = '\u20AC ' + tot.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// === STORICO ===
async function loadStorico(leadId) {
  const container = document.getElementById('storicoTimeline');
  try {
    const snap = await db.collection('leads').doc(leadId).collection('storicoStati').orderBy('data', 'desc').get();
    if (snap.empty) { container.innerHTML = '<div class="timeline-empty">Nessun cambio di stato registrato.</div>'; return; }
    let html = '';
    snap.docs.forEach(d => {
      const s = d.data();
      const date = s.data && s.data.toDate ? s.data.toDate() : new Date();
      const statoObj = allStati.find(st => st.nome === s.statoNuovo);
      const color = statoObj ? statoObj.colore : '#94a3b8';
      html += '<div class="timeline-item" style="border-left-color:' + color + '"><div class="ti-content"><div class="ti-value">' + (s.statoPrecedente || '\u2014') + ' \u2192 ' + s.statoNuovo + '</div><div class="ti-label">' + (s.origine || '') + '</div></div><div class="ti-date">' + date.toLocaleDateString('it-IT') + ' ' + date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) + '</div></div>';
    });
    container.innerHTML = html;
  } catch (e) { container.innerHTML = '<div class="timeline-empty">Errore caricamento storico.</div>'; }
}

// === NOTE ===
async function loadNote(leadId) {
  const container = document.getElementById('noteList');
  try {
    const snap = await db.collection('leads').doc(leadId).collection('note').orderBy('data', 'desc').get();
    if (snap.empty) { container.innerHTML = '<div class="timeline-empty">Nessuna nota ancora.</div>'; return; }
    let html = '';
    snap.docs.forEach(d => {
      const n = d.data();
      const date = n.data && n.data.toDate ? n.data.toDate() : new Date();
      html += '<div class="note-card"><div class="note-text">' + escapeHtml(n.testo) + '</div><div class="note-date">' + date.toLocaleDateString('it-IT') + ' ' + date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) + '</div><button class="note-delete" onclick="deleteNota(\'' + d.id + '\')" title="Elimina nota"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>';
    });
    container.innerHTML = html;
  } catch (e) { container.innerHTML = '<div class="timeline-empty">Errore caricamento note.</div>'; }
}

async function addNota() {
  const testo = document.getElementById('fNuovaNota').value.trim();
  if (!testo) { showToast('Scrivi una nota', 'error'); return; }
  if (!currentLeadId) { showToast('Salva prima l\'anagrafica', 'error'); return; }
  try {
    await db.collection('leads').doc(currentLeadId).collection('note').add({ testo, data: firebase.firestore.FieldValue.serverTimestamp() });
    document.getElementById('fNuovaNota').value = '';
    loadNote(currentLeadId);
    showToast('Nota aggiunta!', 'success');
  } catch (err) { console.error(err); showToast('Errore', 'error'); }
}

async function deleteNota(notaId) {
  if (!confirm('Eliminare questa nota?')) return;
  try {
    await db.collection('leads').doc(currentLeadId).collection('note').doc(notaId).delete();
    loadNote(currentLeadId);
    showToast('Nota eliminata', 'info');
  } catch (err) { console.error(err); showToast('Errore', 'error'); }
}

// === CAMBIA STATO ===
async function changeStato() {
  if (!currentLeadId) return;
  const newStato = document.getElementById('actionStato').value;
  const oldStato = currentLead ? currentLead.stato : 'Nuovo';
  if (newStato === oldStato) return;
  try {
    await db.collection('leads').doc(currentLeadId).update({ stato: newStato });
    await db.collection('leads').doc(currentLeadId).collection('storicoStati').add({ statoPrecedente: oldStato, statoNuovo: newStato, data: firebase.firestore.FieldValue.serverTimestamp(), origine: 'Cambio manuale' });
    if (currentLead) currentLead.stato = newStato;
    const statoObj = allStati.find(s => s.nome === newStato);
    const badge = document.getElementById('detailBadge');
    badge.textContent = newStato;
    badge.style.background = (statoObj ? statoObj.colore : '#64748b') + '20';
    badge.style.color = statoObj ? statoObj.colore : '#64748b';
    loadStorico(currentLeadId);
    showToast('Stato: ' + oldStato + ' \u2192 ' + newStato, 'success');
  } catch (err) { console.error(err); showToast('Errore', 'error'); }
}

// === APPUNTAMENTO ===
async function saveAppointment() {
  const data = document.getElementById('appData').value;
  const ora = document.getElementById('appOra').value;
  if (!data || !ora) { showToast('Data e Ora obbligatori', 'error'); return; }
  try {
    const dateObj = new Date(data + 'T' + ora);
    await db.collection('appuntamenti').add({ leadId: currentLeadId, leadNome: document.getElementById('fNome').value.trim(), leadCognome: document.getElementById('fCognome').value.trim(), data: firebase.firestore.Timestamp.fromDate(dateObj), ora, tipo: document.getElementById('appTipo').value, descrizione: document.getElementById('appDescrizione').value.trim(), completato: false });
    closeModal('appointmentModal');
    document.getElementById('appData').value = ''; document.getElementById('appOra').value = ''; document.getElementById('appDescrizione').value = '';
    showToast('Appuntamento salvato!', 'success');
  } catch (err) { console.error(err); showToast('Errore', 'error'); }
}

// === TEMPLATE ===
function openTemplateModal() {
  const list = document.getElementById('templateList');
  document.getElementById('templatePreview').style.display = 'none';
  if (allTemplates.length === 0) { list.innerHTML = '<div class="timeline-empty">Nessun template disponibile.</div>'; openModal('templateModal'); return; }
  let html = '';
  allTemplates.forEach(t => {
    const tipo = t.tipo || 'WhatsApp';
    html += '<div style="display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;border:1px solid var(--border);margin-bottom:8px;cursor:pointer;transition:all .15s;" onmouseover="this.style.background=\'var(--bg)\'" onmouseout="this.style.background=\'\'" onclick="selectTemplate(\'' + t.id + '\')"><div style="flex:1;"><div style="font-size:14px;font-weight:600;">' + escapeHtml(t.nome) + '</div><div style="font-size:12px;color:var(--text-secondary);margin-top:2px;">' + escapeHtml((t.testo || '').substring(0, 80)) + '...</div></div><span class="badge" style="background:' + (tipo === 'Email' ? 'var(--primary-light)' : '#dcfce7') + ';color:' + (tipo === 'Email' ? 'var(--primary)' : '#25d366') + '">' + tipo + '</span></div>';
  });
  list.innerHTML = html;
  openModal('templateModal');
}

function selectTemplate(id) {
  const t = allTemplates.find(x => x.id === id);
  if (!t) return;
  let text = t.testo || '';
  const lead = currentLead || {};
  const rep = { '{NOME}': lead.nome || '', '{COGNOME}': lead.cognome || '', '{NOME_COMPLETO}': ((lead.nome || '') + ' ' + (lead.cognome || '')).trim(), '{TELEFONO}': lead.telefono || '', '{EMAIL}': lead.email || '', '{CORSO_STUDI}': (lead.studente || {}).corsoStudi || '', '{SCUOLA}': (lead.studente || {}).scuolaAssegnazione || '' };
  Object.entries(rep).forEach(function(kv) { text = text.split(kv[0]).join(kv[1]); });
  currentTemplateText = text;
  document.getElementById('templatePreviewText').textContent = text;
  document.getElementById('templatePreview').style.display = 'block';
  document.getElementById('btnTemplateSendWA').onclick = function() {
    const tel = (lead.telefono || '').replace(/\D/g, '');
    if (tel) window.open('https://wa.me/39' + tel + '?text=' + encodeURIComponent(currentTemplateText), '_blank');
  };
  document.getElementById('btnTemplateSendEmail').onclick = function() {
    const email = lead.email || (lead.studente || {}).email || '';
    if (email) window.open('mailto:' + email + '?body=' + encodeURIComponent(currentTemplateText));
  };
}

// === DELETE ===
async function deleteLead() {
  if (!currentLeadId) return;
  try {
    const stSnap = await db.collection('leads').doc(currentLeadId).collection('storicoStati').get();
    const ntSnap = await db.collection('leads').doc(currentLeadId).collection('note').get();
    const batch = db.batch();
    stSnap.docs.forEach(d => batch.delete(d.ref));
    ntSnap.docs.forEach(d => batch.delete(d.ref));
    batch.delete(db.collection('leads').doc(currentLeadId));
    await batch.commit();
    showToast('Lead eliminato', 'info');
    closeModal('deleteModal');
    setTimeout(function() { window.location.href = 'lead.html'; }, 1000);
  } catch (err) { console.error(err); showToast('Errore', 'error'); }
}

// === UTILS ===
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function showToast(msg, type) {
  type = type || 'info';
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast ' + type + ' show';
  setTimeout(function() { t.classList.remove('show'); }, 3000);
}
function escapeHtml(text) { var d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
</script>
</body>
</html>
